apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: export-pipeline-logs
  labels:
    app.kubernetes.io/managed-by: tekton
spec:
  description: |
    Gather all logs from a completed Tekton PipelineRun, package them into a single
    compressed OCI artifact (tar.gz blob), and push the artifact to a specified Quay
    repository using direct OCI push commands.
  params:
    - name: quay-repo
      type: string
      description: Specify the base OCI repository path
    - name: pipeline-run-name
      type: string
      description: Specify the name of the PipelineRun whose logs should be collected.
    - name: namespace
      type: string
      description: Specify the namespace where the PipelineRun was executed.
      default: "$(context.pipelineRun.namespace)"
    - name: artifact-credentials-secret
      type: string
      description: Specify the name of the secret containing registry credentials.
  results:
    - name: LOG_ARTIFACT_TAG
      description: The specific tag generated for the log artifact.
  volumes:
    - name: credentials-volume
      secret:
        secretName: $(params.artifact-credentials-secret)
    - name: log-workspace
      emptyDir: {}
  steps:
    - name: fetch-and-prepare-logs
      image: quay.io/konflux-ci/tekton-integration-catalog/utils:latest
      workingDir: /var/log-workspace
      volumeMounts:
        - name: log-workspace
          mountPath: /var/log-workspace
      env:
        - name: PR_NAME
          value: "$(params.pipeline-run-name)"
        - name: PR_NAMESPACE
          value: "$(params.namespace)"
        - name: OCI_REPO_WITH_TAG
          value: "$(params.quay-repo)"
      script: |
        #!/bin/bash
        set -euo pipefail

        LOG_FILENAME="all-logs.txt"
        ARCHIVE_FILENAME="logs.tar.gz"

        # shellcheck disable=SC2153
        IMAGE_TAG="${PR_NAME}-$(date +%Y%m%d%H%M%S)-logs"

        CMD="kubectl"

        ${CMD} get pr "${PR_NAME}" -o json -n "${PR_NAMESPACE}" | jq -r '.status.childReferences[].name' | while read -r taskrun; do
            POD_NAME=$(${CMD} get tr "${taskrun}" -o json -n "${PR_NAMESPACE}" | jq -r '.status.podName // empty')

            if [ -n "$POD_NAME" ]; then
                echo "--- LOGS FOR ${taskrun} (Pod: ${POD_NAME}) ---" >> "${LOG_FILENAME}" 2>&1
                ${CMD} logs --namespace "${PR_NAMESPACE}" pod/"${POD_NAME}" >> "${LOG_FILENAME}" 2>&1 || true
            fi
        done

        # Archive and set result if logs exist
        if [ -s "${LOG_FILENAME}" ]; then
            tar -czf "${ARCHIVE_FILENAME}" "${LOG_FILENAME}"
            # Fix SC2046: Quoted command substitution to prevent word splitting.
            echo -n "${IMAGE_TAG}" > "$(results.LOG_ARTIFACT_TAG.path)"
        else
            exit 0
        fi

    - name: secure-push-oci-direct
      image: quay.io/konflux-ci/tekton-integration-catalog/utils:latest
      workingDir: /var/log-workspace
      volumeMounts:
        - name: log-workspace
          mountPath: /var/log-workspace
        - name: credentials-volume
          mountPath: /tekton_volumes_credentials-volume
          readOnly: true
      env:
        - name: OCI_REFERENCE_BASE
          value: $(params.quay-repo)
      script: |
        #!/bin/bash
        set -euo pipefail

        IMAGE_TAG=$(cat "$(results.LOG_ARTIFACT_TAG.path)")

        REPO_NAME_ONLY="${OCI_REFERENCE_BASE%:*}"
        FULL_OCI_REF="${REPO_NAME_ONLY}:${IMAGE_TAG}"

        # Setup authentication
        AUTH_DIR="/tekton_volumes_credentials-volume"
        AUTH_PATH="$AUTH_DIR/.dockerconfigjson"

        if [ -f "$AUTH_PATH" ]; then
          TEMP_DOCKER_CONFIG="$(mktemp -d)"
          cp "$AUTH_PATH" "$TEMP_DOCKER_CONFIG/config.json"
          export DOCKER_CONFIG="$TEMP_DOCKER_CONFIG"
        fi

        # Execute push
        oras push --no-tty \
          --artifact-type "application/vnd.logs.tar+gzip" \
          "${FULL_OCI_REF}" \
          "logs.tar.gz:application/vnd.logs.tar+gzip"

        echo "Successfully pushed log artifact to ${FULL_OCI_REF}"
