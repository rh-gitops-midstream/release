---
# yamllint disable rule:line-length
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: build-rpm-package
  labels:
    build.appstudio.redhat.com/pipeline: "build-rpm-package"
    pipelines.appstudio.openshift.io/type: build
    appstudio.openshift.io/application: rpms
spec:
  finally:
  - name: show-summary
    params:
    - name: pipelinerun-name
      value: $(context.pipelineRun.name)
    - name: git-url
      value: $(tasks.clone-repository.results.url)?rev=$(tasks.clone-repository.results.commit)
    - name: image-url
      value: $(tasks.upload-to-quay.results.IMAGE_URL)
    taskRef:
      params:
      - name: name
        value: summary
      - name: bundle
        value: quay.io/konflux-ci/tekton-catalog/task-summary:0.2@sha256:3f6e8513cbd70f0416eb6c6f2766973a754778526125ff33d8e3633def917091
      - name: kind
        value: task
      resolver: bundles
  - name: show-sbom
    params:
    - name: IMAGE_URL
      value: $(tasks.upload-to-quay.results.IMAGE_URL)
    taskRef:
      params:
      - name: name
        value: show-sbom
      - name: bundle
        value: quay.io/konflux-ci/tekton-catalog/task-show-sbom:0.1@sha256:beb0616db051952b4b861dd8c3e00fa1c0eccbd926feddf71194d3bb3ace9ce7
      - name: kind
        value: task
      resolver: bundles
  params:
  - name: package-name
    description: The name of the package we want to build
  - description: Source Repository URL
    name: git-url
    type: string
  - description: Revision of the Source Repository
    name: revision
    type: string
  - description: The branch name we build against/from
    name: target-branch
    type: string
  - name: build-architectures
    type: array
    default:
    - aarch64
    - ppc64le
    - s390x
    - x86_64
  - default: "false"
    description: Force rebuild image
    name: rebuild
    type: string
  - default: "false"
    description: Skip checks against built image
    name: skip-checks
    type: string
  - default: "true"
    description: Execute the build with network isolation
    name: hermetic
    type: string
  - default: .
    description: Subdirectory of the source directory where the spec file is located. Needed for monorepos.
    name: monorepo-subdir
    type: string
  - description: If Mock Config template exists within source dir, specify where.
    name: mock-config-template-filename-in-sources
    type: string
    default: ""
  - name: build-platforms
    description: List of platform overrides (MPLs).
    type: array
    default:
    - linux/arm64
    - linux/ppc64le
    - linux/s390x
    - linux/amd64
  - name: self-ref-url
    description: |
      Testing-only.  This must be filled as parameter in tests so we can point
      at the Tasks for the same git-revision.
    type: string
    default: "https://github.com/konflux-ci/rpmbuild-pipeline.git"
  - name: self-ref-revision
    description: |
      Testing-only.  This must be filled as parameter in tests so we can point
      at the Tasks for the same git-revision.  For production it defaults to "main".
    type: string
    default: "main"
  - description: |
      Multi-arch container image that ships Mock + the needed Mock
      configuration, dist-git-client, koji-client, and other RPM-build related
      tooling.
    name: script-environment-image
    default: quay.io/redhat-user-workloads/rpm-build-pipeline-tenant/environment:latest@sha256:7f7314c54a2ac2b72da69515789fd3b2c91c1fbfae4710607b91e4f52c52ae00
    type: string
  - name: ociStorage
    description: |
      OCI registry URL where the pipeline stores trusted artifacts, including
      both resulting artifacts and intermediary by-products.
    default: quay.io/redhat-user-workloads/$(context.taskRun.namespace)/$(params.package-name)
  - description: |
      Name of specfile when specfile doesn't have the same prefix name as package name.
      Default is null and package-name.spec is used.
    name: specfile
    type: string
    default: "null"
  - description: How long Trusted Artifacts should be retained
    type: string
    name: ociArtifactExpiresAfter
    default: 14d
  # This part is commented out because the parameter is not usable.  We don't
  # seem to be able to pass the given parameter down to override
  # `spec.tasks.{taskname}.timeout` defaults.  That's why we hardcode (for
  # now?) '72h' in the Task parameters below.  The error is:
  #     Error retrieving pipeline for pipelinerun ...: resolver failed to get
  #     Pipeline : invalid runtime object: time: invalid duration
  #     "$(params.rpmbuild-timeout)"
  # - default: "1h"
  #   description: Timeout for the architecture-specific RPM build tasks.
  #   name: rpmbuild-timeout
  #   type: string
  #
  # The calculate-deps timeouts are not parametrized at all here, we expect
  # that these steps finish quickly enough for all packages (within the
  # default Tekton Task timeout).
  - name: pre-build-script-image
    type: string
  - name: pre-build-script-content
    description: The shell script to execute before the RPM sources are processed.
    type: string
    default: |
      #!/usr/bin/env bash
      set -euxo pipefail
      echo "No pre-build script provided. Skipping."
      # This script must output the artifact path to the result file.
      echo -n "$(params.source-artifact)" | tee $(results.OUTPUT_SOURCE_ARTIFACT.path)
  - name: pre-build-task-url
    description: Git URL for the pre-build-script task definition.
    type: string
    default: "https://github.com/rh-gitops-midstream/release"
  - name: pre-build-task-revision
    description: Git revision for the pre-build-script task definition.
    type: string
    default: "main"
  - name: test-suffix
    description: |
      Testing-only.  In some places we don't want to mix-up "real" component builds
      with "testing" component builds.  If we are testing, set this to some value.
    type: string
    default: ""
  - name: enable-cache-proxy
    default: 'false'
    description: Enable cache proxy configuration
    type: string
  - name: target-distribution
    default: 'fedora-rawhide'
    description: Target distribution. The pipeline expands spec file using macros from the target distribution. Typically specified as ID-VERSION_ID (see /etc/os-release), e.g., rhel-11
    type: string
  - name: enableSymlinkCheck
    description: |
      Whether to enable symlink checks when cloning the git repository.
      Disabling this check is insecure and should only be done in trusted
      environments.
    type: string
    default: true
  results:
  - description: ""
    name: CHAINS-GIT_URL
    value: $(tasks.clone-repository.results.url)
  - description: ""
    name: CHAINS-GIT_COMMIT
    value: $(tasks.clone-repository.results.commit)
  - description: ""
    name: IMAGE_URL
    value: $(tasks.upload-to-quay.results.IMAGE_URL)
  - description: ""
    name: IMAGE_DIGEST
    value: $(tasks.upload-to-quay.results.IMAGE_DIGEST)
  - name: SBOM_BLOB_URL
    description: SPDX SBOM
    value: $(tasks.upload-to-quay.results.SBOM_BLOB_URL)
  - description: ""
    name: PULP-IMAGE_URL
    value: $(tasks.upload-to-quay.results.PULP-IMAGE_URL)
  - description: ""
    name: PULP-IMAGE_DIGEST
    value: $(tasks.upload-to-quay.results.PULP-IMAGE_DIGEST)
  tasks:
  - name: store-start-time
    retries: 3
    taskSpec:
      results:
      - name: timestamp
        description: Timestamp for pipeline start
      steps:
      - name: store-timestamp
        image: registry.access.redhat.com/ubi9
        script: |
          #!/usr/bin/env bash
          set -e
          date "+%s" | tr -d '\n' | tee $(results.timestamp.path)
  - name: init
    retries: 3
    params:
    - name: rebuild
      value: $(params.rebuild)
    - name: skip-checks
      value: $(params.skip-checks)
    - name: image-url
      value: todo - drop
    - name: enable-cache-proxy
      value: $(params.enable-cache-proxy)
    runAfter:
    - store-start-time
    taskRef:
      params:
      - name: name
        value: init
      - name: bundle
        value: quay.io/konflux-ci/tekton-catalog/task-init:0.2@sha256:b349d24cb896573695802d6913d311640b44675ec082b3ad167721946a6a0a71
      - name: kind
        value: task
      resolver: bundles
  - name: clone-repository
    retries: 3
    params:
    - name: url
      value: $(params.git-url)
    - name: revision
      value: $(params.revision)
    - name: depth
      value: 0
    - name: ociStorage
      value: $(params.ociStorage).git
    - name: ociArtifactExpiresAfter
      value: $(params.ociArtifactExpiresAfter)
    - name: enableSymlinkCheck
      value: $(params.enableSymlinkCheck}
    runAfter:
    - init
    taskRef:
      params:
      - name: name
        value: git-clone-oci-ta
      - name: bundle
        value: quay.io/konflux-ci/tekton-catalog/task-git-clone-oci-ta:0.1@sha256:56f65a16d3d0485c64ad85af2c1f3e9b0bb4d02d63f2fd0ebb9498d219ca723d
      - name: kind
        value: task
      resolver: bundles
    workspaces:
    - name: basic-auth
      workspace: git-auth
  - name: pre-build-script
    taskRef:
      resolver: git
      params:
      - name: url
        value: $(params.pre-build-task-url)
      - name: revision
        value: $(params.pre-build-task-revision)
      - name: pathInRepo
        value: .tekton/tasks/pre-build-script.yaml
    runAfter:
    - clone-repository
    params:
    - name: source-artifact
      value: $(tasks.clone-repository.results.SOURCE_ARTIFACT)
    - name: ociStorage
      value: $(params.ociStorage)
    - name: ociArtifactExpiresAfter
      value: $(params.ociArtifactExpiresAfter)
    - name: pre-build-script-image
      value: $(params.pre-build-script-image)
    - name: pre-build-script-content
      value: $(params.pre-build-script-content)
  - name: process-sources
    retries: 3
    taskRef:
      resolver: git
      params:
      - name: url
        value: $(params.self-ref-url)
      - name: revision
        value: $(params.self-ref-revision)
      - name: pathInRepo
        value: task/process-sources.yaml
      - name: ociArtifactExpiresAfter
        value: $(params.ociArtifactExpiresAfter)
    runAfter:
    - pre-build-script
    params:
    - name: package-name
      value: $(params.package-name)
    - name: specfile
      value: $(params.specfile)
    - name: source-artifact
      value: $(tasks.pre-build-script.results.OUTPUT_SOURCE_ARTIFACT)
    - name: ociStorage
      value: $(params.ociStorage).rpm-sources
    - name: ociArtifactExpiresAfter
      value: $(params.ociArtifactExpiresAfter)
    - name: script-environment-image
      value: $(params.script-environment-image)
    - name: hermetic
      value: $(params.hermetic)
    - name: monorepo-subdir
      value: $(params.monorepo-subdir)
    - name: build-architectures
      value: [ "$(params.build-architectures[*])" ]
    - name: build-platforms
      value: [ "$(params.build-platforms[*])" ]
    - name: target-distribution
      value: $(params.target-distribution)
  - name: prepare-mock-config
    retries: 3
    taskRef:
      resolver: git
      params:
      - name: url
        value: $(params.self-ref-url)
      - name: revision
        value: $(params.self-ref-revision)
      - name: pathInRepo
        value: task/prepare-mock-config.yaml
    runAfter:
    - clone-repository
    params:
    - name: source-artifact
      value: $(tasks.clone-repository.results.SOURCE_ARTIFACT)
    - name: ociStorage
      value: $(params.ociStorage).mock-config
    - name: script-environment-image
      value: $(params.script-environment-image)
    - name: mock-config-template-filename-in-sources
      value: $(params.mock-config-template-filename-in-sources)
    - name: chroot
      value: fedora-rawhide-@ARCH@
    - name: ociArtifactExpiresAfter
      value: $(params.ociArtifactExpiresAfter)
  - name: calculate-deps-x86-64
    runAfter:
    - process-sources
    - prepare-mock-config
    params:
    - name: package-name
      value: $(params.package-name)
    - name: target-branch
      value: $(params.target-branch)
    - name: mock-config-template-file
      value: $(tasks.prepare-mock-config.results.mock-config-template-file)
    - name: PLATFORM
      value: $(tasks.process-sources.results.skip-mpc-tasks.deps-x86_64)
    - name: script-environment-image
      value: $(params.script-environment-image)
    - name: dependencies-artifact
      value: $(tasks.process-sources.results.dependencies-artifact)
    - name: ociStorage
      value: $(params.ociStorage).calculation-x86_64
    - name: ociArtifactExpiresAfter
      value: $(params.ociArtifactExpiresAfter)
    - name: specfile
      value: $(params.specfile)
    taskRef:
      resolver: git
      params:
      - name: url
        value: $(params.self-ref-url)
      - name: revision
        value: $(params.self-ref-revision)
      - name: pathInRepo
        value: task/calculate-deps.yaml
  - name: rpmbuild-x86-64
    runAfter:
    - calculate-deps-x86-64
    timeout: "72h"
    params:
    - name: package-name
      value: $(params.package-name)
    - name: target-branch
      value: $(params.target-branch)
    - name: mock-config-template-file
      value: $(tasks.prepare-mock-config.results.mock-config-template-file)
    - name: PLATFORM
      value: $(tasks.process-sources.results.skip-mpc-tasks.build-x86_64)
    - name: script-environment-image
      value: $(params.script-environment-image)
    - name: hermetic
      value: $(params.hermetic)
    - name: dependencies-artifact
      value: $(tasks.process-sources.results.dependencies-artifact)
    - name: calculation-artifact
      value: $(tasks.calculate-deps-x86-64.results.calculation-artifact)
    - name: ociStorage
      value: $(params.ociStorage).rpmbuild-x86_64
    - name: ociArtifactExpiresAfter
      value: $(params.ociArtifactExpiresAfter)
    - name: specfile
      value: $(params.specfile)
    taskRef:
      resolver: git
      params:
      - name: url
        value: $(params.self-ref-url)
      - name: revision
        value: $(params.self-ref-revision)
      - name: pathInRepo
        value: task/rpmbuild.yaml
  - name: calculate-deps-aarch64
    runAfter:
    - process-sources
    - prepare-mock-config
    params:
    - name: package-name
      value: $(params.package-name)
    - name: target-branch
      value: $(params.target-branch)
    - name: mock-config-template-file
      value: $(tasks.prepare-mock-config.results.mock-config-template-file)
    - name: PLATFORM
      value: $(tasks.process-sources.results.skip-mpc-tasks.deps-aarch64)
    - name: script-environment-image
      value: $(params.script-environment-image)
    - name: dependencies-artifact
      value: $(tasks.process-sources.results.dependencies-artifact)
    - name: ociStorage
      value: $(params.ociStorage).calculation-aarch64
    - name: ociArtifactExpiresAfter
      value: $(params.ociArtifactExpiresAfter)
    - name: specfile
      value: $(params.specfile)
    taskRef:
      resolver: git
      params:
      - name: url
        value: $(params.self-ref-url)
      - name: revision
        value: $(params.self-ref-revision)
      - name: pathInRepo
        value: task/calculate-deps.yaml
  - name: rpmbuild-aarch64
    runAfter:
    - calculate-deps-aarch64
    timeout: "72h"
    params:
    - name: package-name
      value: $(params.package-name)
    - name: target-branch
      value: $(params.target-branch)
    - name: mock-config-template-file
      value: $(tasks.prepare-mock-config.results.mock-config-template-file)
    - name: PLATFORM
      value: $(tasks.process-sources.results.skip-mpc-tasks.build-aarch64)
    - name: script-environment-image
      value: $(params.script-environment-image)
    - name: hermetic
      value: $(params.hermetic)
    - name: dependencies-artifact
      value: $(tasks.process-sources.results.dependencies-artifact)
    - name: calculation-artifact
      value: $(tasks.calculate-deps-aarch64.results.calculation-artifact)
    - name: ociStorage
      value: $(params.ociStorage).rpmbuild-aarch64
    - name: ociArtifactExpiresAfter
      value: $(params.ociArtifactExpiresAfter)
    - name: specfile
      value: $(params.specfile)
    taskRef:
      resolver: git
      params:
      - name: url
        value: $(params.self-ref-url)
      - name: revision
        value: $(params.self-ref-revision)
      - name: pathInRepo
        value: task/rpmbuild.yaml
  - name: calculate-deps-s390x
    runAfter:
    - process-sources
    - prepare-mock-config
    params:
    - name: package-name
      value: $(params.package-name)
    - name: target-branch
      value: $(params.target-branch)
    - name: mock-config-template-file
      value: $(tasks.prepare-mock-config.results.mock-config-template-file)
    - name: PLATFORM
      value: $(tasks.process-sources.results.skip-mpc-tasks.deps-s390x)
    - name: script-environment-image
      value: $(params.script-environment-image)
    - name: dependencies-artifact
      value: $(tasks.process-sources.results.dependencies-artifact)
    - name: ociStorage
      value: $(params.ociStorage).calculation-s390x
    - name: ociArtifactExpiresAfter
      value: $(params.ociArtifactExpiresAfter)
    - name: specfile
      value: $(params.specfile)
    taskRef:
      resolver: git
      params:
      - name: url
        value: $(params.self-ref-url)
      - name: revision
        value: $(params.self-ref-revision)
      - name: pathInRepo
        value: task/calculate-deps.yaml
  - name: rpmbuild-s390x
    runAfter:
    - calculate-deps-s390x
    timeout: "72h"
    params:
    - name: package-name
      value: $(params.package-name)
    - name: target-branch
      value: $(params.target-branch)
    - name: mock-config-template-file
      value: $(tasks.prepare-mock-config.results.mock-config-template-file)
    - name: PLATFORM
      value: $(tasks.process-sources.results.skip-mpc-tasks.build-s390x)
    - name: script-environment-image
      value: $(params.script-environment-image)
    - name: hermetic
      value: $(params.hermetic)
    - name: dependencies-artifact
      value: $(tasks.process-sources.results.dependencies-artifact)
    - name: calculation-artifact
      value: $(tasks.calculate-deps-s390x.results.calculation-artifact)
    - name: ociStorage
      value: $(params.ociStorage).rpmbuild-s390x
    - name: ociArtifactExpiresAfter
      value: $(params.ociArtifactExpiresAfter)
    - name: specfile
      value: $(params.specfile)
    taskRef:
      resolver: git
      params:
      - name: url
        value: $(params.self-ref-url)
      - name: revision
        value: $(params.self-ref-revision)
      - name: pathInRepo
        value: task/rpmbuild.yaml
  - name: calculate-deps-ppc64le
    runAfter:
    - process-sources
    - prepare-mock-config
    params:
    - name: package-name
      value: $(params.package-name)
    - name: target-branch
      value: $(params.target-branch)
    - name: mock-config-template-file
      value: $(tasks.prepare-mock-config.results.mock-config-template-file)
    - name: PLATFORM
      value: $(tasks.process-sources.results.skip-mpc-tasks.deps-ppc64le)
    - name: script-environment-image
      value: $(params.script-environment-image)
    - name: dependencies-artifact
      value: $(tasks.process-sources.results.dependencies-artifact)
    - name: ociStorage
      value: $(params.ociStorage).calculation-ppc64le
    - name: ociArtifactExpiresAfter
      value: $(params.ociArtifactExpiresAfter)
    - name: specfile
      value: $(params.specfile)
    taskRef:
      resolver: git
      params:
      - name: url
        value: $(params.self-ref-url)
      - name: revision
        value: $(params.self-ref-revision)
      - name: pathInRepo
        value: task/calculate-deps.yaml
  - name: rpmbuild-ppc64le
    runAfter:
    - calculate-deps-ppc64le
    timeout: "72h"
    params:
    - name: package-name
      value: $(params.package-name)
    - name: target-branch
      value: $(params.target-branch)
    - name: mock-config-template-file
      value: $(tasks.prepare-mock-config.results.mock-config-template-file)
    - name: PLATFORM
      value: $(tasks.process-sources.results.skip-mpc-tasks.build-ppc64le)
    - name: script-environment-image
      value: $(params.script-environment-image)
    - name: hermetic
      value: $(params.hermetic)
    - name: dependencies-artifact
      value: $(tasks.process-sources.results.dependencies-artifact)
    - name: calculation-artifact
      value: $(tasks.calculate-deps-ppc64le.results.calculation-artifact)
    - name: ociStorage
      value: $(params.ociStorage).rpmbuild-ppc64le
    - name: ociArtifactExpiresAfter
      value: $(params.ociArtifactExpiresAfter)
    - name: specfile
      value: $(params.specfile)
    taskRef:
      resolver: git
      params:
      - name: url
        value: $(params.self-ref-url)
      - name: revision
        value: $(params.self-ref-revision)
      - name: pathInRepo
        value: task/rpmbuild.yaml
  - name: upload-to-quay
    params:
    - name: ociStorage
      value: $(params.ociStorage)
    - name: git-url
      value: $(params.git-url)
    - name: revision
      value: $(params.revision)
    - name: package-name
      value: $(params.package-name)
    - name: start-time
      value: $(tasks.store-start-time.results.timestamp)
    - name: pipelinerun-id
      value: $(context.pipelineRun.namespace)/$(context.pipelineRun.name)
    - name: x86_64-artifact
      value: $(tasks.rpmbuild-x86-64.results.rpmbuild-artifact)
    - name: aarch64-artifact
      value: $(tasks.rpmbuild-aarch64.results.rpmbuild-artifact)
    - name: s390x-artifact
      value: $(tasks.rpmbuild-s390x.results.rpmbuild-artifact)
    - name: ppc64le-artifact
      value: $(tasks.rpmbuild-ppc64le.results.rpmbuild-artifact)
    - name: script-environment-image
      value: $(params.script-environment-image)
    runAfter:
    - rpmbuild-s390x
    - rpmbuild-x86-64
    - rpmbuild-aarch64
    - rpmbuild-ppc64le
    taskRef:
      resolver: git
      params:
      - name: url
        value: $(params.self-ref-url)
      - name: revision
        value: $(params.self-ref-revision)
      - name: pathInRepo
        value: task/import-to-quay.yaml
  - name: check-noarch-rpms
    runAfter:
    - rpmbuild-s390x
    - rpmbuild-x86-64
    - rpmbuild-aarch64
    - rpmbuild-ppc64le
    params:
    - name: x86_64-artifact
      value: $(tasks.rpmbuild-x86-64.results.rpmbuild-artifact)
    - name: aarch64-artifact
      value: $(tasks.rpmbuild-aarch64.results.rpmbuild-artifact)
    - name: s390x-artifact
      value: $(tasks.rpmbuild-s390x.results.rpmbuild-artifact)
    - name: ppc64le-artifact
      value: $(tasks.rpmbuild-ppc64le.results.rpmbuild-artifact)
    - name: script-environment-image
      value: $(params.script-environment-image)
    taskRef:
      resolver: git
      params:
      - name: url
        value: $(params.self-ref-url)
      - name: revision
        value: $(params.self-ref-revision)
      - name: pathInRepo
        value: task/check-noarch.yaml
  workspaces:
  - name: git-auth
    optional: true
