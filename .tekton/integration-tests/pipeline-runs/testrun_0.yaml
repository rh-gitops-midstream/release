apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  generateName: gitops-bundle-e2e-parallel-
  annotations:
    pac.test.appstudio.openshift.io/log-url: 'https://konflux-ui.apps.stone-prd-rh01.pg1f.p1.openshiftapps.com/ns/rh-openshift-gitops-tenant/pipelinerun/gitops-bundle-e2e-parallel-bx7mh'
    test.appstudio.openshift.io/group-test-info: '[{"namespace":"rh-openshift-gitops-tenant","component":"argocd-agentctl-main","buildPipelineRun":"argocd-agentctl-main-on-pull-request-b45j8","snapshot":"gitops-main-20260223-111543-000-ps","repoUrl":"https://github.com/rh-gitops-midstream/release","pullRequestNumber":"631"},{"namespace":"rh-openshift-gitops-tenant","component":"argocd-agent-main","buildPipelineRun":"argocd-agent-main-on-pull-request-zjs6t","snapshot":"gitops-main-20260223-111543-000-4j","repoUrl":"https://github.com/rh-gitops-midstream/release","pullRequestNumber":"631"},{"namespace":"rh-openshift-gitops-tenant","component":"argocd-cli-main","buildPipelineRun":"argocd-cli-main-on-pull-request-x7pc5","snapshot":"gitops-main-20260223-111541-000-lq","repoUrl":"https://github.com/rh-gitops-midstream/release","pullRequestNumber":"631"},{"namespace":"rh-openshift-gitops-tenant","component":"console-plugin-main","buildPipelineRun":"console-plugin-main-on-pull-request-n5l95","snapshot":"gitops-main-20260223-111542-000-i0","repoUrl":"https://github.com/rh-gitops-midstream/release","pullRequestNumber":"631"},{"namespace":"rh-openshift-gitops-tenant","component":"dex-main","buildPipelineRun":"dex-main-on-pull-request-mrjdq","snapshot":"gitops-main-20260223-111542-000","repoUrl":"https://github.com/rh-gitops-midstream/release","pullRequestNumber":"631"},{"namespace":"rh-openshift-gitops-tenant","component":"gitops-operator-main","buildPipelineRun":"gitops-operator-main-on-pull-request-tghhz","snapshot":"gitops-main-20260223-111542-000-p8","repoUrl":"https://github.com/rh-gitops-midstream/release","pullRequestNumber":"631"},{"namespace":"rh-openshift-gitops-tenant","component":"argocd-image-updater-main","buildPipelineRun":"argocd-image-updater-main-on-pull-request-5ql7j","snapshot":"gitops-main-20260223-111542-000-78","repoUrl":"https://github.com/rh-gitops-midstream/release","pullRequestNumber":"631"},{"namespace":"rh-openshift-gitops-tenant","component":"argocd-main","buildPipelineRun":"argocd-main-on-pull-request-ngzgk","snapshot":"gitops-main-20260223-111541-000","repoUrl":"https://github.com/rh-gitops-midstream/release","pullRequestNumber":"631"},{"namespace":"rh-openshift-gitops-tenant","component":"gitops-main","buildPipelineRun":"gitops-main-on-pull-request-h2rtb","snapshot":"gitops-main-20260223-111542-000-d0","repoUrl":"https://github.com/rh-gitops-midstream/release","pullRequestNumber":"631"},{"namespace":"rh-openshift-gitops-tenant","component":"gitops-operator-bundle-main","buildPipelineRun":"gitops-operator-bundle-main-on-pull-request-hbqz5","snapshot":"gitops-main-20260223-111542-000-8g","repoUrl":"https://github.com/rh-gitops-midstream/release","pullRequestNumber":"631"},{"namespace":"rh-openshift-gitops-tenant","component":"argocd-extensions-main","buildPipelineRun":"argocd-extensions-main-on-pull-request-xmr5w","snapshot":"gitops-main-20260223-111543-000","repoUrl":"https://github.com/rh-gitops-midstream/release","pullRequestNumber":"631"},{"namespace":"rh-openshift-gitops-tenant","component":"kubectl-argo-rollouts-cli-main","buildPipelineRun":"kubectl-argo-rollouts-cli-main-on-pull-request-vmb6l","snapshot":"gitops-main-20260223-111542-000-xn","repoUrl":"https://github.com/rh-gitops-midstream/release","pullRequestNumber":"631"},{"namespace":"rh-openshift-gitops-tenant","component":"must-gather-main","buildPipelineRun":"must-gather-main-on-pull-request-xkqbp","snapshot":"gitops-main-20260223-111540-000","repoUrl":"https://github.com/rh-gitops-midstream/release","pullRequestNumber":"631"},{"namespace":"rh-openshift-gitops-tenant","component":"argo-rollouts-main","buildPipelineRun":"argo-rollouts-main-on-pull-request-lxttq","snapshot":"gitops-main-20260223-111543-000-vp","repoUrl":"https://github.com/rh-gitops-midstream/release","pullRequestNumber":"631"}]'
    test.appstudio.openshift.io/pr-group: konflux
    test.appstudio.openshift.io/status: '[{"scenario":"gitops-bundle-e2e-parallel","status":"Pending","lastUpdateTime":"2026-02-23T12:04:27.665898074Z","details":"Pending"}]'
  resourceVersion: '7431222148'
  name: gitops-bundle-e2e-parallel-bx7mh
  uid: 4dae3aec-64d4-49a8-a450-f01a830ed6a4
  creationTimestamp: '2026-02-23T12:04:27Z'
  generation: 2
  managedFields:
    - apiVersion: tekton.dev/v1
      fieldsType: FieldsV1
      fieldsV1:
        'f:metadata':
          'f:annotations':
            .: {}
            'f:pac.test.appstudio.openshift.io/log-url': {}
            'f:test.appstudio.openshift.io/group-test-info': {}
            'f:test.appstudio.openshift.io/pr-group': {}
            'f:test.appstudio.openshift.io/status': {}
          'f:finalizers':
            .: {}
            'v:"test.appstudio.openshift.io/pipelinerun"': {}
          'f:generateName': {}
          'f:labels':
            'f:test.appstudio.openshift.io/scenario': {}
            'f:pipelines.appstudio.openshift.io/type': {}
            'f:test.appstudio.openshift.io/pr-group-sha': {}
            'f:appstudio.openshift.io/application': {}
            'f:appstudio.openshift.io/snapshot': {}
            .: {}
            'f:test.appstudio.openshift.io/type': {}
            'f:test.appstudio.openshift.io/optional': {}
            'f:pac.test.appstudio.openshift.io/event-type': {}
          'f:ownerReferences':
            .: {}
            'k:{"uid":"f4a9e6a1-4d60-4b69-b103-0e8c501fb359"}': {}
        'f:spec':
          .: {}
          'f:params': {}
          'f:pipelineRef':
            .: {}
            'f:params': {}
            'f:resolver': {}
          'f:taskRunTemplate':
            .: {}
            'f:serviceAccountName': {}
          'f:timeouts':
            .: {}
            'f:finally': {}
            'f:pipeline': {}
            'f:tasks': {}
      manager: manager
      operation: Update
      time: '2026-02-23T12:04:28Z'
    - apiVersion: tekton.dev/v1
      fieldsType: FieldsV1
      fieldsV1:
        'f:metadata':
          'f:finalizers':
            'v:"results.tekton.dev/pipelinerun"': {}
      manager: watcher
      operation: Update
      time: '2026-02-23T12:04:28Z'
    - apiVersion: tekton.dev/v1
      fieldsType: FieldsV1
      fieldsV1:
        'f:metadata':
          'f:finalizers':
            'v:"chains.tekton.dev/pipelinerun"': {}
          'f:labels':
            'f:tekton.dev/pipeline': {}
      manager: controller
      operation: Update
      time: '2026-02-23T12:04:29Z'
    - apiVersion: tekton.dev/v1
      fieldsType: FieldsV1
      fieldsV1:
        'f:status':
          .: {}
          'f:childReferences': {}
          'f:conditions': {}
          'f:pipelineSpec':
            .: {}
            'f:description': {}
            'f:finally': {}
            'f:params': {}
            'f:tasks': {}
          'f:spanContext':
            .: {}
            'f:traceparent': {}
          'f:startTime': {}
      manager: controller
      operation: Update
      subresource: status
      time: '2026-02-23T12:06:39Z'
  namespace: rh-openshift-gitops-tenant
  ownerReferences:
    - apiVersion: appstudio.redhat.com/v1alpha1
      blockOwnerDeletion: true
      controller: true
      kind: Snapshot
      name: gitops-main-20260223-120424-833
      uid: f4a9e6a1-4d60-4b69-b103-0e8c501fb359
  finalizers:
    - test.appstudio.openshift.io/pipelinerun
    - results.tekton.dev/pipelinerun
    - chains.tekton.dev/pipelinerun
  labels:
    appstudio.openshift.io/snapshot: gitops-main-20260223-120424-833
    test.appstudio.openshift.io/optional: 'true'
    pac.test.appstudio.openshift.io/event-type: retest-all-comment
    test.appstudio.openshift.io/scenario: gitops-bundle-e2e-parallel
    kueue.x-k8s.io/queue-name: pipelines-queue
    tekton.dev/pipeline: gitops-bundle-lowest-parallel-integration-test-pipeline
    test.appstudio.openshift.io/pr-group-sha: 6729e8dee730d9cc9b174868d6622f4d0bf0c7a400d22ecb9d84d7e68c7dbf
    appstudio.openshift.io/application: gitops-main
    kueue.x-k8s.io/priority-class: konflux-default
    pipelines.appstudio.openshift.io/type: test
    test.appstudio.openshift.io/type: group
spec:
  params:
    - name: SNAPSHOT
      value: '{"application":"gitops-main","components":[{"name":"argocd-agentctl-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-agentctl@sha256:ac08c6959cc77ac7020449574e5c26debe7f7eab910593214ea046e9992f6729","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"rpm-microshift-gitops-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/rpm-microshift-gitops-main@sha256:7e054ae6a735e4889f7e7a9a498704544471f616477159a0e39d937825b146c5","source":{"git":{"url":"https://github.com/rh-gitops-midstream/release.git","revision":"e5f75600b56aeae852da3e833ef543edf0dad9b7","context":"rpms/microshift-gitops"}}},{"name":"test-microshift-rpm-build","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/test-microshift-rpm-build@sha256:66c68abc89bba2e1226038363b0099ee773d554d0e27f6254fbae992f9173b2b","source":{"git":{"url":"https://github.com/rh-gitops-midstream/release.git","revision":"1c71181a68d29e86b994a562c1eea392205a824a","context":"rpms/microshift-gitops"}}},{"name":"argocd-agent-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-agent-rhel9@sha256:e7fce4cf9dedf42e1e19e4866e94b929a81efacc9c7d01c43db217a22d83a6a8","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"argocd-cli-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-cli@sha256:8a21adf3b35ffeca42df26f651719e5c4c7d70a58dee63aa6956f6b3b924d136","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"argocd-rhel9-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-rhel9@sha256:64d2042a1437597e1ae0e53726e4ae63905294eaf2ba876e6bea17e2c5063e73","source":{"git":{"url":"https://github.com/rh-gitops-midstream/release.git","revision":"9fa2b1a88fbdc254223e997e4391586477082418","dockerfileUrl":"containers/argocd-rhel9/Dockerfile"}}},{"name":"console-plugin-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/console-plugin-rhel9@sha256:49d1ee07f0ec8dd892426536be05cffce636a8b3ef5731d3efd6d6d5955f7609","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"dex-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/dex-rhel9@sha256:f854f06e4297349c904c773fd24b8b490e0d71c6065fed00f2698bb8ae8f1f40","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"gitops-operator-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/gitops-rhel9-operator@sha256:9c447a7b2412eb107fc9d54be03d8d14bae44094325c8cb587a62d466aa2bae6","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"argocd-image-updater-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-image-updater-rhel9@sha256:d37a81f4a8977604f8856b9d73425f6a9d45849454955dd34165c328e2af53ca","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"argocd-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-rhel9@sha256:e5db8f29883642f9c2431a4c00ef6cf5d4ecb161fd9d9c9be911866503e9f7ad","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"gitops-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/gitops-rhel9@sha256:27f9f53ed7822c6fecdf17b29c0852ccd8d53b9f0ec4582ddc7cdf0a73b64c36","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"gitops-operator-bundle-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/gitops-operator-bundle@sha256:2cf9309e23b9c5f880674f87629f2367af28b3ba7c3a8a2c61ec0e49377b160a","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"argocd-extensions-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-extensions-rhel9@sha256:a3852516e0fb0941f4bb6b6437acc99608d31b909e4f53f06a22bb379f35e534","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"kubectl-argo-rollouts-cli-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/kubectl-argo-rollouts-cli@sha256:6a32fc903da853da9db9b5445993173b50b70d7c31217c8f35db641be69a6797","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"must-gather-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/must-gather-rhel9@sha256:549bc54b783c049d9e199f3ba982d87b43fcc7453092c1f8c27f4ed7681ac2b7","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"argo-rollouts-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argo-rollouts-rhel9@sha256:f8ba1d19c8899e317c9725ffb1c999d74085dfa10b18a1b8ea7b4786220cf754","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}}],"artifacts":{}}'
  pipelineRef:
    params:
      - name: url
        value: 'https://github.com/AdamSaleh/release/'
      - name: revision
        value: konflux
      - name: pathInRepo
        value: .tekton/integration-tests/pipelines/gitops-bundle-lowest-integration-test-pipeline.yaml
    resolver: git
  taskRunTemplate:
    podTemplate:
      nodeSelector:
        konflux-ci.dev/workload: konflux-tenants
      tolerations:
        - effect: NoSchedule
          key: konflux-ci.dev/workload
          operator: Equal
          value: konflux-tenants
    serviceAccountName: konflux-integration-runner
  timeouts:
    finally: 2h0m0s
    pipeline: 6h0m0s
    tasks: 4h0m0s
status:
  childReferences:
    - apiVersion: tekton.dev/v1
      kind: TaskRun
      name: gitops-bundle-e2e-parallel-bx7mh-parse-metadata
      pipelineTaskName: parse-metadata
    - apiVersion: tekton.dev/v1
      kind: TaskRun
      name: gitops-bundle-e2e-parallel-bx7mh-patch-bundle-images
      pipelineTaskName: patch-bundle-images
    - apiVersion: tekton.dev/v1
      kind: TaskRun
      name: gitops-bundle-e2e-parallel-bx7mh-provision-eaas-space
      pipelineTaskName: provision-eaas-space
    - apiVersion: tekton.dev/v1
      kind: TaskRun
      name: gitops-bundle-e2e-parallel-bx7mh-provision-cluster
      pipelineTaskName: provision-cluster
  conditions:
    - lastTransitionTime: '2026-02-23T12:06:39Z'
      message: 'Tasks Completed: 3 (Failed: 0, Cancelled 0), Incomplete: 4, Skipped: 0'
      reason: Running
      status: Unknown
      type: Succeeded
  pipelineSpec:
    description: |
      An integration test which provisions an ephemeral Hypershift cluster and deploys an Operator
      bundle from a Konflux snapshot.
    finally:
      - name: export-logs-and-notify
        taskSpec:
          metadata: {}
          spec: null
          steps:
            - computeResources: {}
              name: prepare-and-push-logs
              params:
                - name: pipeline-run-name
                  value: gitops-bundle-e2e-parallel-bx7mh
                - name: namespace
                  value: rh-openshift-gitops-tenant
                - name: quay-repo
                  value: quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/gitops-operator-bundle
                - name: credentials-volume
                  value: credentials-volume
              ref:
                params:
                  - name: url
                    value: 'https://github.com/AdamSaleh/release.git'
                  - name: revision
                    value: konflux
                  - name: pathInRepo
                    value: .tekton/steps/prepare-and-push-logs.yaml
                resolver: git
          volumes:
            - name: credentials-volume
              secret:
                secretName: gitops-operator-bundle-quay-image-repository-image-push
        status:
          reason: Pending
    params:
      - default: '{"components": [{"name":"gitops-operator-bundle-main", "containerImage": "quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/gitops-operator-bundle:latest"}]}'
        description: Snapshot of the application
        name: SNAPSHOT
        type: string
      - default: default
        description: Namespace where the the Operator bundle will be deployed.
        name: NAMESPACE
        type: string
      - default: 25m
        description: Duration to wait for bundle installation to complete before failing.
        name: INSTALL_TIMEOUT
        type: string
    tasks:
      - name: parse-metadata
        params:
          - name: SNAPSHOT
            value: '{"application":"gitops-main","components":[{"name":"argocd-agentctl-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-agentctl@sha256:ac08c6959cc77ac7020449574e5c26debe7f7eab910593214ea046e9992f6729","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"rpm-microshift-gitops-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/rpm-microshift-gitops-main@sha256:7e054ae6a735e4889f7e7a9a498704544471f616477159a0e39d937825b146c5","source":{"git":{"url":"https://github.com/rh-gitops-midstream/release.git","revision":"e5f75600b56aeae852da3e833ef543edf0dad9b7","context":"rpms/microshift-gitops"}}},{"name":"test-microshift-rpm-build","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/test-microshift-rpm-build@sha256:66c68abc89bba2e1226038363b0099ee773d554d0e27f6254fbae992f9173b2b","source":{"git":{"url":"https://github.com/rh-gitops-midstream/release.git","revision":"1c71181a68d29e86b994a562c1eea392205a824a","context":"rpms/microshift-gitops"}}},{"name":"argocd-agent-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-agent-rhel9@sha256:e7fce4cf9dedf42e1e19e4866e94b929a81efacc9c7d01c43db217a22d83a6a8","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"argocd-cli-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-cli@sha256:8a21adf3b35ffeca42df26f651719e5c4c7d70a58dee63aa6956f6b3b924d136","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"argocd-rhel9-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-rhel9@sha256:64d2042a1437597e1ae0e53726e4ae63905294eaf2ba876e6bea17e2c5063e73","source":{"git":{"url":"https://github.com/rh-gitops-midstream/release.git","revision":"9fa2b1a88fbdc254223e997e4391586477082418","dockerfileUrl":"containers/argocd-rhel9/Dockerfile"}}},{"name":"console-plugin-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/console-plugin-rhel9@sha256:49d1ee07f0ec8dd892426536be05cffce636a8b3ef5731d3efd6d6d5955f7609","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"dex-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/dex-rhel9@sha256:f854f06e4297349c904c773fd24b8b490e0d71c6065fed00f2698bb8ae8f1f40","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"gitops-operator-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/gitops-rhel9-operator@sha256:9c447a7b2412eb107fc9d54be03d8d14bae44094325c8cb587a62d466aa2bae6","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"argocd-image-updater-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-image-updater-rhel9@sha256:d37a81f4a8977604f8856b9d73425f6a9d45849454955dd34165c328e2af53ca","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"argocd-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-rhel9@sha256:e5db8f29883642f9c2431a4c00ef6cf5d4ecb161fd9d9c9be911866503e9f7ad","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"gitops-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/gitops-rhel9@sha256:27f9f53ed7822c6fecdf17b29c0852ccd8d53b9f0ec4582ddc7cdf0a73b64c36","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"gitops-operator-bundle-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/gitops-operator-bundle@sha256:2cf9309e23b9c5f880674f87629f2367af28b3ba7c3a8a2c61ec0e49377b160a","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"argocd-extensions-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-extensions-rhel9@sha256:a3852516e0fb0941f4bb6b6437acc99608d31b909e4f53f06a22bb379f35e534","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"kubectl-argo-rollouts-cli-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/kubectl-argo-rollouts-cli@sha256:6a32fc903da853da9db9b5445993173b50b70d7c31217c8f35db641be69a6797","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"must-gather-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/must-gather-rhel9@sha256:549bc54b783c049d9e199f3ba982d87b43fcc7453092c1f8c27f4ed7681ac2b7","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"argo-rollouts-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argo-rollouts-rhel9@sha256:f8ba1d19c8899e317c9725ffb1c999d74085dfa10b18a1b8ea7b4786220cf754","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}}],"artifacts":{}}'
        taskRef:
          params:
            - name: url
              value: 'https://github.com/konflux-ci/integration-examples'
            - name: revision
              value: main
            - name: pathInRepo
              value: tasks/test_metadata.yaml
          resolver: git
        status:
          taskSpec:
            params:
              - description: The JSON string of the Snapshot under test
                name: SNAPSHOT
                type: string
            results:
              - description: Stores information about the event type that indicates if a job is running for a Pull Request or Push event
                name: test-event-type
                type: string
              - description: Stores information about the pull request number if exists
                name: pull-request-number
                type: string
              - description: Stores information about the pull request sender if exists
                name: sender
                type: string
              - description: Stores information about the source git url for the change. Can be from a fork or from the same repo.
                name: source-git-url
                type: string
              - description: Stores information about the source git revision for the change.
                name: source-git-revision
                type: string
              - description: Stores information about the target git repository.
                name: target-git-url
                type: string
              - description: Stores information about the target git branch.
                name: target-git-branch
                type: string
              - description: Stores information about the Konflux application that the Snapshot was created for.
                name: application-name
                type: string
              - description: Stores information about the Konflux component that was built in case of the component-type Snapshot.
                name: component-name
                type: string
              - description: Stores information about the component's container that was built in case of the component-type Snapshot.
                name: component-container-image
                type: string
            steps:
              - computeResources: {}
                env:
                  - name: SNAPSHOT
                    value: '{"application":"gitops-main","components":[{"name":"argocd-agentctl-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-agentctl@sha256:ac08c6959cc77ac7020449574e5c26debe7f7eab910593214ea046e9992f6729","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"rpm-microshift-gitops-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/rpm-microshift-gitops-main@sha256:7e054ae6a735e4889f7e7a9a498704544471f616477159a0e39d937825b146c5","source":{"git":{"url":"https://github.com/rh-gitops-midstream/release.git","revision":"e5f75600b56aeae852da3e833ef543edf0dad9b7","context":"rpms/microshift-gitops"}}},{"name":"test-microshift-rpm-build","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/test-microshift-rpm-build@sha256:66c68abc89bba2e1226038363b0099ee773d554d0e27f6254fbae992f9173b2b","source":{"git":{"url":"https://github.com/rh-gitops-midstream/release.git","revision":"1c71181a68d29e86b994a562c1eea392205a824a","context":"rpms/microshift-gitops"}}},{"name":"argocd-agent-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-agent-rhel9@sha256:e7fce4cf9dedf42e1e19e4866e94b929a81efacc9c7d01c43db217a22d83a6a8","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"argocd-cli-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-cli@sha256:8a21adf3b35ffeca42df26f651719e5c4c7d70a58dee63aa6956f6b3b924d136","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"argocd-rhel9-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-rhel9@sha256:64d2042a1437597e1ae0e53726e4ae63905294eaf2ba876e6bea17e2c5063e73","source":{"git":{"url":"https://github.com/rh-gitops-midstream/release.git","revision":"9fa2b1a88fbdc254223e997e4391586477082418","dockerfileUrl":"containers/argocd-rhel9/Dockerfile"}}},{"name":"console-plugin-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/console-plugin-rhel9@sha256:49d1ee07f0ec8dd892426536be05cffce636a8b3ef5731d3efd6d6d5955f7609","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"dex-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/dex-rhel9@sha256:f854f06e4297349c904c773fd24b8b490e0d71c6065fed00f2698bb8ae8f1f40","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"gitops-operator-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/gitops-rhel9-operator@sha256:9c447a7b2412eb107fc9d54be03d8d14bae44094325c8cb587a62d466aa2bae6","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"argocd-image-updater-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-image-updater-rhel9@sha256:d37a81f4a8977604f8856b9d73425f6a9d45849454955dd34165c328e2af53ca","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"argocd-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-rhel9@sha256:e5db8f29883642f9c2431a4c00ef6cf5d4ecb161fd9d9c9be911866503e9f7ad","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"gitops-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/gitops-rhel9@sha256:27f9f53ed7822c6fecdf17b29c0852ccd8d53b9f0ec4582ddc7cdf0a73b64c36","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"gitops-operator-bundle-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/gitops-operator-bundle@sha256:2cf9309e23b9c5f880674f87629f2367af28b3ba7c3a8a2c61ec0e49377b160a","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"argocd-extensions-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-extensions-rhel9@sha256:a3852516e0fb0941f4bb6b6437acc99608d31b909e4f53f06a22bb379f35e534","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"kubectl-argo-rollouts-cli-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/kubectl-argo-rollouts-cli@sha256:6a32fc903da853da9db9b5445993173b50b70d7c31217c8f35db641be69a6797","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"must-gather-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/must-gather-rhel9@sha256:549bc54b783c049d9e199f3ba982d87b43fcc7453092c1f8c27f4ed7681ac2b7","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"argo-rollouts-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argo-rollouts-rhel9@sha256:f8ba1d19c8899e317c9725ffb1c999d74085dfa10b18a1b8ea7b4786220cf754","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}}],"artifacts":{}}'
                  - name: EVENT_TYPE
                    valueFrom:
                      fieldRef:
                        fieldPath: 'metadata.labels[''pac.test.appstudio.openshift.io/event-type'']'
                  - name: APPLICATION_NAME
                    valueFrom:
                      fieldRef:
                        fieldPath: 'metadata.labels[''appstudio.openshift.io/application'']'
                  - name: COMPONENT_NAME
                    valueFrom:
                      fieldRef:
                        fieldPath: 'metadata.labels[''appstudio.openshift.io/component'']'
                  - name: PULL_REQUEST_NUMBER
                    valueFrom:
                      fieldRef:
                        fieldPath: 'metadata.labels[''pac.test.appstudio.openshift.io/pull-request'']'
                  - name: TARGET_GIT_URL
                    valueFrom:
                      fieldRef:
                        fieldPath: 'metadata.annotations[''pac.test.appstudio.openshift.io/repo-url'']'
                  - name: TARGET_GIT_BRANCH
                    valueFrom:
                      fieldRef:
                        fieldPath: 'metadata.annotations[''pac.test.appstudio.openshift.io/branch'']'
                  - name: SENDER
                    valueFrom:
                      fieldRef:
                        fieldPath: 'metadata.annotations[''pac.test.appstudio.openshift.io/sender'']'
                image: 'quay.io/konflux-ci/konflux-test:stable'
                name: test-metadata
                script: |
                  #!/bin/sh

                  # Derive additional environment variables from SNAPSHOT
                  SOURCE_GIT_URL=$(jq -r --arg component_name "${COMPONENT_NAME}" '.components[] | select(.name == $component_name) | .source.git.url' <<< "${SNAPSHOT}")
                  SOURCE_GIT_REVISION=$(jq -r --arg component_name "${COMPONENT_NAME}" '.components[] | select(.name == $component_name) | .source.git.revision' <<< "${SNAPSHOT}")
                  COMPONENT_CONTAINER_IMAGE=$(jq -r --arg component_name "${COMPONENT_NAME}" '.components[] | select(.name == $component_name) | .containerImage' <<< "${SNAPSHOT}")

                  # Log declared environment variables
                  echo "Integration Test metadata:"
                  echo "  SNAPSHOT: ${SNAPSHOT}"
                  echo "  EVENT_TYPE: ${EVENT_TYPE}"
                  echo "  PULL_REQUEST_NUMBER: ${PULL_REQUEST_NUMBER}"
                  echo "  SOURCE_GIT_URL: ${SOURCE_GIT_URL}"
                  echo "  SOURCE_GIT_REVISION: ${SOURCE_GIT_REVISION}"
                  echo "  TARGET_GIT_REPOSITORY: ${TARGET_GIT_REPOSITORY}"
                  echo "  TARGET_GIT_BRANCH: ${TARGET_GIT_BRANCH}"
                  echo "  APPLICATION_NAME: ${APPLICATION_NAME}"
                  echo "  COMPONENT_NAME: ${COMPONENT_NAME}"
                  echo "  COMPONENT_CONTAINER_IMAGE: ${COMPONENT_CONTAINER_IMAGE}"

                  # Write each environment variable to its respective results:
                  echo -n "${EVENT_TYPE}" > /tekton/results/test-event-type
                  echo -n "${PULL_REQUEST_NUMBER}" > /tekton/results/pull-request-number
                  echo -n "${SENDER}" > /tekton/results/sender
                  echo -n "${SOURCE_GIT_URL}" > /tekton/results/source-git-url
                  echo -n "${SOURCE_GIT_REVISION}" > /tekton/results/source-git-revision
                  echo -n "${TARGET_GIT_URL}" > /tekton/results/target-git-url
                  echo -n "${TARGET_GIT_BRANCH}" > /tekton/results/target-git-branch
                  echo -n "${APPLICATION_NAME}" > /tekton/results/application-name
                  echo -n "${COMPONENT_NAME}" > /tekton/results/component-name
                  echo -n "${COMPONENT_CONTAINER_IMAGE}" > /tekton/results/component-container-image
                workingDir: /workspace
          artifacts: {}
          spanContext:
            traceparent: 00-1070772e949fae646a3da2e60282064b-a01573f3329e14d1-01
          steps:
            - container: step-test-metadata
              imageID: 'quay.io/konflux-ci/konflux-test@sha256:09328e5f47da168ffe951ec9c4242cd6761e61e0a235df1bba3f5158e757446d'
              name: test-metadata
              provenance: {}
              terminated:
                containerID: 'cri-o://e5226b4f6e038c21a67a1fde3c486ebc51c4a6d81da11400a10cee8ce444e9c8'
                exitCode: 0
                finishedAt: '2026-02-23T12:04:40Z'
                message: '[{"key":"application-name","value":"gitops-main","type":1},{"key":"component-container-image","value":"","type":1},{"key":"component-name","value":"","type":1},{"key":"pull-request-number","value":"","type":1},{"key":"sender","value":"","type":1},{"key":"source-git-revision","value":"","type":1},{"key":"source-git-url","value":"","type":1},{"key":"target-git-branch","value":"","type":1},{"key":"target-git-url","value":"","type":1},{"key":"test-event-type","value":"retest-all-comment","type":1}]'
                reason: Completed
                startedAt: '2026-02-23T12:04:40Z'
              terminationReason: Completed
          completionTime: '2026-02-23T12:04:41Z'
          startTime: '2026-02-23T12:04:36Z'
          podName: gitops-bundle-e2e-parallel-bx7mh-parse-metadata-pod
          results:
            - name: application-name
              type: string
              value: gitops-main
            - name: component-container-image
              type: string
              value: ''
            - name: component-name
              type: string
              value: ''
            - name: pull-request-number
              type: string
              value: ''
            - name: sender
              type: string
              value: ''
            - name: source-git-revision
              type: string
              value: ''
            - name: source-git-url
              type: string
              value: ''
            - name: target-git-branch
              type: string
              value: ''
            - name: target-git-url
              type: string
              value: ''
            - name: test-event-type
              type: string
              value: retest-all-comment
          conditions:
            - lastTransitionTime: '2026-02-23T12:04:41Z'
              message: All Steps have completed executing
              reason: Succeeded
              status: 'True'
              type: Succeeded
          duration: 5s
          reason: Succeeded
      - name: patch-bundle-images
        params:
          - name: SNAPSHOT
            value: '{"application":"gitops-main","components":[{"name":"argocd-agentctl-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-agentctl@sha256:ac08c6959cc77ac7020449574e5c26debe7f7eab910593214ea046e9992f6729","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"rpm-microshift-gitops-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/rpm-microshift-gitops-main@sha256:7e054ae6a735e4889f7e7a9a498704544471f616477159a0e39d937825b146c5","source":{"git":{"url":"https://github.com/rh-gitops-midstream/release.git","revision":"e5f75600b56aeae852da3e833ef543edf0dad9b7","context":"rpms/microshift-gitops"}}},{"name":"test-microshift-rpm-build","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/test-microshift-rpm-build@sha256:66c68abc89bba2e1226038363b0099ee773d554d0e27f6254fbae992f9173b2b","source":{"git":{"url":"https://github.com/rh-gitops-midstream/release.git","revision":"1c71181a68d29e86b994a562c1eea392205a824a","context":"rpms/microshift-gitops"}}},{"name":"argocd-agent-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-agent-rhel9@sha256:e7fce4cf9dedf42e1e19e4866e94b929a81efacc9c7d01c43db217a22d83a6a8","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"argocd-cli-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-cli@sha256:8a21adf3b35ffeca42df26f651719e5c4c7d70a58dee63aa6956f6b3b924d136","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"argocd-rhel9-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-rhel9@sha256:64d2042a1437597e1ae0e53726e4ae63905294eaf2ba876e6bea17e2c5063e73","source":{"git":{"url":"https://github.com/rh-gitops-midstream/release.git","revision":"9fa2b1a88fbdc254223e997e4391586477082418","dockerfileUrl":"containers/argocd-rhel9/Dockerfile"}}},{"name":"console-plugin-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/console-plugin-rhel9@sha256:49d1ee07f0ec8dd892426536be05cffce636a8b3ef5731d3efd6d6d5955f7609","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"dex-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/dex-rhel9@sha256:f854f06e4297349c904c773fd24b8b490e0d71c6065fed00f2698bb8ae8f1f40","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"gitops-operator-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/gitops-rhel9-operator@sha256:9c447a7b2412eb107fc9d54be03d8d14bae44094325c8cb587a62d466aa2bae6","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"argocd-image-updater-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-image-updater-rhel9@sha256:d37a81f4a8977604f8856b9d73425f6a9d45849454955dd34165c328e2af53ca","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"argocd-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-rhel9@sha256:e5db8f29883642f9c2431a4c00ef6cf5d4ecb161fd9d9c9be911866503e9f7ad","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"gitops-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/gitops-rhel9@sha256:27f9f53ed7822c6fecdf17b29c0852ccd8d53b9f0ec4582ddc7cdf0a73b64c36","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"gitops-operator-bundle-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/gitops-operator-bundle@sha256:2cf9309e23b9c5f880674f87629f2367af28b3ba7c3a8a2c61ec0e49377b160a","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"argocd-extensions-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-extensions-rhel9@sha256:a3852516e0fb0941f4bb6b6437acc99608d31b909e4f53f06a22bb379f35e534","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"kubectl-argo-rollouts-cli-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/kubectl-argo-rollouts-cli@sha256:6a32fc903da853da9db9b5445993173b50b70d7c31217c8f35db641be69a6797","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"must-gather-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/must-gather-rhel9@sha256:549bc54b783c049d9e199f3ba982d87b43fcc7453092c1f8c27f4ed7681ac2b7","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"argo-rollouts-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argo-rollouts-rhel9@sha256:f8ba1d19c8899e317c9725ffb1c999d74085dfa10b18a1b8ea7b4786220cf754","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}}],"artifacts":{}}'
          - name: pipelineRunName
            value: gitops-bundle-e2e-parallel-bx7mh
        runAfter:
          - parse-metadata
        taskSpec:
          metadata: {}
          params:
            - name: SNAPSHOT
              type: string
            - name: pipelineRunName
              type: string
          results:
            - description: Fully qualified reference (by digest) to the patched bundle image with all component images updated to the SNAPSHOT digests.
              name: patchedBundleImage
              type: string
          spec: null
          steps:
            - computeResources: {}
              env:
                - name: BUILDAH_FORMAT
                  value: oci
                - name: STORAGE_DRIVER
                  value: vfs
                - name: SNAPSHOT_JSON
                  value: '{"application":"gitops-main","components":[{"name":"argocd-agentctl-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-agentctl@sha256:ac08c6959cc77ac7020449574e5c26debe7f7eab910593214ea046e9992f6729","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"rpm-microshift-gitops-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/rpm-microshift-gitops-main@sha256:7e054ae6a735e4889f7e7a9a498704544471f616477159a0e39d937825b146c5","source":{"git":{"url":"https://github.com/rh-gitops-midstream/release.git","revision":"e5f75600b56aeae852da3e833ef543edf0dad9b7","context":"rpms/microshift-gitops"}}},{"name":"test-microshift-rpm-build","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/test-microshift-rpm-build@sha256:66c68abc89bba2e1226038363b0099ee773d554d0e27f6254fbae992f9173b2b","source":{"git":{"url":"https://github.com/rh-gitops-midstream/release.git","revision":"1c71181a68d29e86b994a562c1eea392205a824a","context":"rpms/microshift-gitops"}}},{"name":"argocd-agent-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-agent-rhel9@sha256:e7fce4cf9dedf42e1e19e4866e94b929a81efacc9c7d01c43db217a22d83a6a8","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"argocd-cli-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-cli@sha256:8a21adf3b35ffeca42df26f651719e5c4c7d70a58dee63aa6956f6b3b924d136","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"argocd-rhel9-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-rhel9@sha256:64d2042a1437597e1ae0e53726e4ae63905294eaf2ba876e6bea17e2c5063e73","source":{"git":{"url":"https://github.com/rh-gitops-midstream/release.git","revision":"9fa2b1a88fbdc254223e997e4391586477082418","dockerfileUrl":"containers/argocd-rhel9/Dockerfile"}}},{"name":"console-plugin-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/console-plugin-rhel9@sha256:49d1ee07f0ec8dd892426536be05cffce636a8b3ef5731d3efd6d6d5955f7609","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"dex-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/dex-rhel9@sha256:f854f06e4297349c904c773fd24b8b490e0d71c6065fed00f2698bb8ae8f1f40","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"gitops-operator-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/gitops-rhel9-operator@sha256:9c447a7b2412eb107fc9d54be03d8d14bae44094325c8cb587a62d466aa2bae6","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"argocd-image-updater-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-image-updater-rhel9@sha256:d37a81f4a8977604f8856b9d73425f6a9d45849454955dd34165c328e2af53ca","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"argocd-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-rhel9@sha256:e5db8f29883642f9c2431a4c00ef6cf5d4ecb161fd9d9c9be911866503e9f7ad","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"gitops-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/gitops-rhel9@sha256:27f9f53ed7822c6fecdf17b29c0852ccd8d53b9f0ec4582ddc7cdf0a73b64c36","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"gitops-operator-bundle-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/gitops-operator-bundle@sha256:2cf9309e23b9c5f880674f87629f2367af28b3ba7c3a8a2c61ec0e49377b160a","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"argocd-extensions-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-extensions-rhel9@sha256:a3852516e0fb0941f4bb6b6437acc99608d31b909e4f53f06a22bb379f35e534","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"kubectl-argo-rollouts-cli-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/kubectl-argo-rollouts-cli@sha256:6a32fc903da853da9db9b5445993173b50b70d7c31217c8f35db641be69a6797","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"must-gather-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/must-gather-rhel9@sha256:549bc54b783c049d9e199f3ba982d87b43fcc7453092c1f8c27f4ed7681ac2b7","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"argo-rollouts-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argo-rollouts-rhel9@sha256:f8ba1d19c8899e317c9725ffb1c999d74085dfa10b18a1b8ea7b4786220cf754","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}}],"artifacts":{}}'
                - name: PIPELINE_RUN_NAME
                  value: $(params.pipelineRunName)
              image: 'registry.access.redhat.com/ubi9/buildah:latest'
              name: patch-and-push-bundle
              script: |
                #!/usr/bin/env bash
                set -euxo pipefail

                echo "============================================"
                echo "=== patch-and-push-bundle START ==="
                echo "============================================"

                # ------------------------------------------------------------------
                # 0. Debug: show what we received
                # ------------------------------------------------------------------
                echo "=== SNAPSHOT_JSON ==="
                echo "${SNAPSHOT_JSON}" | python3 -m json.tool 2>/dev/null || echo "${SNAPSHOT_JSON}"
                echo "=== END SNAPSHOT_JSON ==="

                echo "=== PIPELINE_RUN_NAME: ${PIPELINE_RUN_NAME} ==="

                # ------------------------------------------------------------------
                # 1. Extract bundle image from the SNAPSHOT
                # ------------------------------------------------------------------
                echo "=== Extracting bundle image from SNAPSHOT ==="
                BUNDLE_IMAGE=$(echo "${SNAPSHOT_JSON}" | python3 -c "
                import json, sys
                snap = json.load(sys.stdin)
                for c in snap.get('components', []):
                    name = c.get('name', '')
                    image = c.get('containerImage', '')
                    print(f'  component: {name} -> {image}', file=sys.stderr)
                    if 'bundle' in name.lower():
                        print(image)
                        sys.exit(0)
                print('ERROR: No bundle component found in SNAPSHOT', file=sys.stderr)
                sys.exit(1)
                ")

                echo "=== Bundle image from SNAPSHOT: ${BUNDLE_IMAGE} ==="

                # ------------------------------------------------------------------
                # 2. Configure registry authentication
                # ------------------------------------------------------------------
                echo "=== Configuring registry auth ==="
                echo "  Contents of /push-credentials/:"
                ls -la /push-credentials/ || echo "  (directory not found)"

                AUTH_DIR="${HOME}/.docker"
                mkdir -p "${AUTH_DIR}"

                if [ -f /push-credentials/.dockerconfigjson ]; then
                  echo "  Using /push-credentials/.dockerconfigjson"
                  cp /push-credentials/.dockerconfigjson "${AUTH_DIR}/config.json"
                elif [ -f /push-credentials/config.json ]; then
                  echo "  Using /push-credentials/config.json"
                  cp /push-credentials/config.json "${AUTH_DIR}/config.json"
                elif [ -f /push-credentials/.dockercfg ]; then
                  echo "  Using /push-credentials/.dockercfg (legacy format)"
                  cp /push-credentials/.dockercfg "${AUTH_DIR}/config.json"
                else
                  echo "  WARNING: No known credential file found, listing all files:"
                  find /push-credentials/ -type f 2>/dev/null || true
                  echo "  Push will likely fail"
                fi

                export REGISTRY_AUTH_FILE="${AUTH_DIR}/config.json"
                echo "  Auth file size: $(wc -c < "${REGISTRY_AUTH_FILE}" 2>/dev/null || echo 'missing') bytes"
                # Show which registries have auth (without leaking tokens)
                python3 -c "
                import json
                try:
                    with open('${REGISTRY_AUTH_FILE}') as f:
                        cfg = json.load(f)
                    auths = cfg.get('auths', {})
                    print(f'  Registries with credentials: {list(auths.keys())}')
                except Exception as e:
                    print(f'  Could not parse auth file: {e}')
                " || true

                # ------------------------------------------------------------------
                # 3. Pull bundle and mount its filesystem
                # ------------------------------------------------------------------
                echo "=== Pulling bundle image: ${BUNDLE_IMAGE} ==="
                container=$(buildah from --pull=always --authfile "${REGISTRY_AUTH_FILE}" "${BUNDLE_IMAGE}")
                echo "=== Container created: ${container} ==="

                mountpoint=$(buildah mount "${container}")
                echo "=== Mounted at: ${mountpoint} ==="

                echo "=== Bundle image contents ==="
                find "${mountpoint}" -maxdepth 3 -type f 2>/dev/null || true
                echo "=== End bundle contents ==="

                # ------------------------------------------------------------------
                # 4. Locate the ClusterServiceVersion
                # ------------------------------------------------------------------
                echo "=== Searching for ClusterServiceVersion ==="
                CSV_FILE=$(find "${mountpoint}" \
                  -name "*.clusterserviceversion.yaml" 2>/dev/null | head -1)

                if [ -z "${CSV_FILE}" ]; then
                  echo "ERROR: No ClusterServiceVersion found in bundle"
                  echo "=== Full bundle tree ==="
                  find "${mountpoint}" -type f 2>/dev/null || true
                  exit 1
                fi
                echo "=== Found CSV: ${CSV_FILE} ==="

                echo "--- Original image references in CSV ---"
                grep -n 'image:\|RELATED_IMAGE' "${CSV_FILE}" || echo "(none found)"
                echo "--- End original image references ---"

                # ------------------------------------------------------------------
                # 5. Patch image references using the SNAPSHOT
                # ------------------------------------------------------------------
                echo "=== Patching image references ==="
                export CSV_PATH="${CSV_FILE}"
                python3 << 'PYEOF'
                import json, os, re, sys

                snapshot = json.loads(os.environ['SNAPSHOT_JSON'])
                csv_path = os.environ['CSV_PATH']

                with open(csv_path, 'r') as f:
                    content = f.read()

                original_content = content
                patched_count = 0

                print("Components in SNAPSHOT:")
                for comp in snapshot.get('components', []):
                    name  = comp.get('name', '')
                    image = comp.get('containerImage', '')
                    print(f"  - {name}: {image}")

                print("\nPatching CSV:")
                for comp in snapshot.get('components', []):
                    name  = comp.get('name', '')
                    image = comp.get('containerImage', '')

                    if not image:
                        print(f"  [skip] {name} (no containerImage)")
                        continue

                    # Skip the bundle component itself  we are patching *it*
                    if 'bundle' in name.lower():
                        print(f"  [skip] {name} (bundle component)")
                        continue

                    # Derive the short image name, e.g. "argocd-rhel9"
                    image_ref  = image.split('@')[0] if '@' in image else image.split(':')[0]
                    short_name = image_ref.split('/')[-1]

                    # Match any fully-qualified image reference whose final path
                    # segment equals short_name, followed by @sha256: or :tag
                    #   e.g.  registry.redhat.io/openshift-gitops-1/argocd-rhel9@sha256:abc
                    #   e.g.  quay.io//argocd-rhel9:on-pr-631
                    pattern = (
                        r'[a-zA-Z0-9._:/-]*/'
                        + re.escape(short_name)
                        + r'[@:][^\s"\',}\]]*'
                    )

                    # Show what we're trying to match
                    matches = re.findall(pattern, content)
                    print(f"  [{short_name}] pattern: {pattern}")
                    print(f"  [{short_name}] matches found: {matches}")

                    new_content, count = re.subn(pattern, image, content)
                    if count > 0:
                        print(f"  [patch] {short_name}: {count} ref(s) -> {image}")
                        content = new_content
                        patched_count += count
                    else:
                        print(f"  [miss]  {short_name}: no matching references in CSV")

                if patched_count == 0:
                    print("\nWARNING: No image references were patched. "
                          "Check that component names match image paths in the CSV.",
                          file=sys.stderr)
                    # Still continue  the original bundle may work as-is
                else:
                    print(f"\nPatched {patched_count} total image reference(s).")

                if content != original_content:
                    with open(csv_path, 'w') as f:
                        f.write(content)
                    print("CSV file updated on disk.")
                else:
                    print("CSV file unchanged (no patches applied).")
                PYEOF

                echo ""
                echo "--- Patched image references in CSV ---"
                grep -n 'image:\|RELATED_IMAGE' "${CSV_FILE}" || echo "(none found)"
                echo "--- End patched image references ---"

                # ------------------------------------------------------------------
                # 6. Commit the modified bundle and push
                # ------------------------------------------------------------------
                buildah unmount "${container}"

                PUSH_REPO="quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/gitops-operator-bundle"
                PUSH_TAG="patched-${PIPELINE_RUN_NAME}"
                PUSH_TARGET="${PUSH_REPO}:${PUSH_TAG}"

                echo "=== Committing patched bundle ==="
                buildah commit "${container}" "${PUSH_TARGET}"

                echo "=== Pushing to: ${PUSH_TARGET} ==="
                DIGEST_FILE="/tmp/patched-bundle-digest"
                buildah push --authfile "${REGISTRY_AUTH_FILE}" \
                  --digestfile "${DIGEST_FILE}" \
                  "${PUSH_TARGET}"

                DIGEST=$(cat "${DIGEST_FILE}")
                PATCHED_REF="${PUSH_REPO}@${DIGEST}"

                echo "============================================"
                echo "=== PATCHED BUNDLE: ${PATCHED_REF} ==="
                echo "============================================"
                printf '%s' "${PATCHED_REF}" > "$(results.patchedBundleImage.path)"
              securityContext:
                capabilities:
                  add:
                    - SETFCAP
              volumeMounts:
                - mountPath: /push-credentials
                  name: push-credentials
                  readOnly: true
          volumes:
            - name: push-credentials
              secret:
                secretName: gitops-operator-bundle-quay-image-repository-image-push
        status:
          taskSpec:
            params:
              - name: SNAPSHOT
                type: string
              - name: pipelineRunName
                type: string
            results:
              - description: Fully qualified reference (by digest) to the patched bundle image with all component images updated to the SNAPSHOT digests.
                name: patchedBundleImage
                type: string
            steps:
              - computeResources: {}
                env:
                  - name: BUILDAH_FORMAT
                    value: oci
                  - name: STORAGE_DRIVER
                    value: vfs
                  - name: SNAPSHOT_JSON
                    value: '{"application":"gitops-main","components":[{"name":"argocd-agentctl-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-agentctl@sha256:ac08c6959cc77ac7020449574e5c26debe7f7eab910593214ea046e9992f6729","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"rpm-microshift-gitops-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/rpm-microshift-gitops-main@sha256:7e054ae6a735e4889f7e7a9a498704544471f616477159a0e39d937825b146c5","source":{"git":{"url":"https://github.com/rh-gitops-midstream/release.git","revision":"e5f75600b56aeae852da3e833ef543edf0dad9b7","context":"rpms/microshift-gitops"}}},{"name":"test-microshift-rpm-build","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/test-microshift-rpm-build@sha256:66c68abc89bba2e1226038363b0099ee773d554d0e27f6254fbae992f9173b2b","source":{"git":{"url":"https://github.com/rh-gitops-midstream/release.git","revision":"1c71181a68d29e86b994a562c1eea392205a824a","context":"rpms/microshift-gitops"}}},{"name":"argocd-agent-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-agent-rhel9@sha256:e7fce4cf9dedf42e1e19e4866e94b929a81efacc9c7d01c43db217a22d83a6a8","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"argocd-cli-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-cli@sha256:8a21adf3b35ffeca42df26f651719e5c4c7d70a58dee63aa6956f6b3b924d136","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"argocd-rhel9-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-rhel9@sha256:64d2042a1437597e1ae0e53726e4ae63905294eaf2ba876e6bea17e2c5063e73","source":{"git":{"url":"https://github.com/rh-gitops-midstream/release.git","revision":"9fa2b1a88fbdc254223e997e4391586477082418","dockerfileUrl":"containers/argocd-rhel9/Dockerfile"}}},{"name":"console-plugin-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/console-plugin-rhel9@sha256:49d1ee07f0ec8dd892426536be05cffce636a8b3ef5731d3efd6d6d5955f7609","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"dex-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/dex-rhel9@sha256:f854f06e4297349c904c773fd24b8b490e0d71c6065fed00f2698bb8ae8f1f40","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"gitops-operator-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/gitops-rhel9-operator@sha256:9c447a7b2412eb107fc9d54be03d8d14bae44094325c8cb587a62d466aa2bae6","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"argocd-image-updater-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-image-updater-rhel9@sha256:d37a81f4a8977604f8856b9d73425f6a9d45849454955dd34165c328e2af53ca","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"argocd-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-rhel9@sha256:e5db8f29883642f9c2431a4c00ef6cf5d4ecb161fd9d9c9be911866503e9f7ad","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"gitops-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/gitops-rhel9@sha256:27f9f53ed7822c6fecdf17b29c0852ccd8d53b9f0ec4582ddc7cdf0a73b64c36","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"gitops-operator-bundle-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/gitops-operator-bundle@sha256:2cf9309e23b9c5f880674f87629f2367af28b3ba7c3a8a2c61ec0e49377b160a","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"argocd-extensions-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-extensions-rhel9@sha256:a3852516e0fb0941f4bb6b6437acc99608d31b909e4f53f06a22bb379f35e534","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"kubectl-argo-rollouts-cli-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/kubectl-argo-rollouts-cli@sha256:6a32fc903da853da9db9b5445993173b50b70d7c31217c8f35db641be69a6797","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"must-gather-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/must-gather-rhel9@sha256:549bc54b783c049d9e199f3ba982d87b43fcc7453092c1f8c27f4ed7681ac2b7","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}},{"name":"argo-rollouts-main","containerImage":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argo-rollouts-rhel9@sha256:f8ba1d19c8899e317c9725ffb1c999d74085dfa10b18a1b8ea7b4786220cf754","source":{"git":{"url":"https://github.com/AdamSaleh/release","revision":"2da6cb92ff23b09c1f42b83ca77c58221c0d1e4f"}}}],"artifacts":{}}'
                  - name: PIPELINE_RUN_NAME
                    value: gitops-bundle-e2e-parallel-bx7mh
                image: 'registry.access.redhat.com/ubi9/buildah:latest'
                name: patch-and-push-bundle
                script: |
                  #!/usr/bin/env bash
                  set -euxo pipefail

                  echo "============================================"
                  echo "=== patch-and-push-bundle START ==="
                  echo "============================================"

                  # ------------------------------------------------------------------
                  # 0. Debug: show what we received
                  # ------------------------------------------------------------------
                  echo "=== SNAPSHOT_JSON ==="
                  echo "${SNAPSHOT_JSON}" | python3 -m json.tool 2>/dev/null || echo "${SNAPSHOT_JSON}"
                  echo "=== END SNAPSHOT_JSON ==="

                  echo "=== PIPELINE_RUN_NAME: ${PIPELINE_RUN_NAME} ==="

                  # ------------------------------------------------------------------
                  # 1. Extract bundle image from the SNAPSHOT
                  # ------------------------------------------------------------------
                  echo "=== Extracting bundle image from SNAPSHOT ==="
                  BUNDLE_IMAGE=$(echo "${SNAPSHOT_JSON}" | python3 -c "
                  import json, sys
                  snap = json.load(sys.stdin)
                  for c in snap.get('components', []):
                      name = c.get('name', '')
                      image = c.get('containerImage', '')
                      print(f'  component: {name} -> {image}', file=sys.stderr)
                      if 'bundle' in name.lower():
                          print(image)
                          sys.exit(0)
                  print('ERROR: No bundle component found in SNAPSHOT', file=sys.stderr)
                  sys.exit(1)
                  ")

                  echo "=== Bundle image from SNAPSHOT: ${BUNDLE_IMAGE} ==="

                  # ------------------------------------------------------------------
                  # 2. Configure registry authentication
                  # ------------------------------------------------------------------
                  echo "=== Configuring registry auth ==="
                  echo "  Contents of /push-credentials/:"
                  ls -la /push-credentials/ || echo "  (directory not found)"

                  AUTH_DIR="${HOME}/.docker"
                  mkdir -p "${AUTH_DIR}"

                  if [ -f /push-credentials/.dockerconfigjson ]; then
                    echo "  Using /push-credentials/.dockerconfigjson"
                    cp /push-credentials/.dockerconfigjson "${AUTH_DIR}/config.json"
                  elif [ -f /push-credentials/config.json ]; then
                    echo "  Using /push-credentials/config.json"
                    cp /push-credentials/config.json "${AUTH_DIR}/config.json"
                  elif [ -f /push-credentials/.dockercfg ]; then
                    echo "  Using /push-credentials/.dockercfg (legacy format)"
                    cp /push-credentials/.dockercfg "${AUTH_DIR}/config.json"
                  else
                    echo "  WARNING: No known credential file found, listing all files:"
                    find /push-credentials/ -type f 2>/dev/null || true
                    echo "  Push will likely fail"
                  fi

                  export REGISTRY_AUTH_FILE="${AUTH_DIR}/config.json"
                  echo "  Auth file size: $(wc -c < "${REGISTRY_AUTH_FILE}" 2>/dev/null || echo 'missing') bytes"
                  # Show which registries have auth (without leaking tokens)
                  python3 -c "
                  import json
                  try:
                      with open('${REGISTRY_AUTH_FILE}') as f:
                          cfg = json.load(f)
                      auths = cfg.get('auths', {})
                      print(f'  Registries with credentials: {list(auths.keys())}')
                  except Exception as e:
                      print(f'  Could not parse auth file: {e}')
                  " || true

                  # ------------------------------------------------------------------
                  # 3. Pull bundle and mount its filesystem
                  # ------------------------------------------------------------------
                  echo "=== Pulling bundle image: ${BUNDLE_IMAGE} ==="
                  container=$(buildah from --pull=always --authfile "${REGISTRY_AUTH_FILE}" "${BUNDLE_IMAGE}")
                  echo "=== Container created: ${container} ==="

                  mountpoint=$(buildah mount "${container}")
                  echo "=== Mounted at: ${mountpoint} ==="

                  echo "=== Bundle image contents ==="
                  find "${mountpoint}" -maxdepth 3 -type f 2>/dev/null || true
                  echo "=== End bundle contents ==="

                  # ------------------------------------------------------------------
                  # 4. Locate the ClusterServiceVersion
                  # ------------------------------------------------------------------
                  echo "=== Searching for ClusterServiceVersion ==="
                  CSV_FILE=$(find "${mountpoint}" \
                    -name "*.clusterserviceversion.yaml" 2>/dev/null | head -1)

                  if [ -z "${CSV_FILE}" ]; then
                    echo "ERROR: No ClusterServiceVersion found in bundle"
                    echo "=== Full bundle tree ==="
                    find "${mountpoint}" -type f 2>/dev/null || true
                    exit 1
                  fi
                  echo "=== Found CSV: ${CSV_FILE} ==="

                  echo "--- Original image references in CSV ---"
                  grep -n 'image:\|RELATED_IMAGE' "${CSV_FILE}" || echo "(none found)"
                  echo "--- End original image references ---"

                  # ------------------------------------------------------------------
                  # 5. Patch image references using the SNAPSHOT
                  # ------------------------------------------------------------------
                  echo "=== Patching image references ==="
                  export CSV_PATH="${CSV_FILE}"
                  python3 << 'PYEOF'
                  import json, os, re, sys

                  snapshot = json.loads(os.environ['SNAPSHOT_JSON'])
                  csv_path = os.environ['CSV_PATH']

                  with open(csv_path, 'r') as f:
                      content = f.read()

                  original_content = content
                  patched_count = 0

                  print("Components in SNAPSHOT:")
                  for comp in snapshot.get('components', []):
                      name  = comp.get('name', '')
                      image = comp.get('containerImage', '')
                      print(f"  - {name}: {image}")

                  print("\nPatching CSV:")
                  for comp in snapshot.get('components', []):
                      name  = comp.get('name', '')
                      image = comp.get('containerImage', '')

                      if not image:
                          print(f"  [skip] {name} (no containerImage)")
                          continue

                      # Skip the bundle component itself  we are patching *it*
                      if 'bundle' in name.lower():
                          print(f"  [skip] {name} (bundle component)")
                          continue

                      # Derive the short image name, e.g. "argocd-rhel9"
                      image_ref  = image.split('@')[0] if '@' in image else image.split(':')[0]
                      short_name = image_ref.split('/')[-1]

                      # Match any fully-qualified image reference whose final path
                      # segment equals short_name, followed by @sha256: or :tag
                      #   e.g.  registry.redhat.io/openshift-gitops-1/argocd-rhel9@sha256:abc
                      #   e.g.  quay.io//argocd-rhel9:on-pr-631
                      pattern = (
                          r'[a-zA-Z0-9._:/-]*/'
                          + re.escape(short_name)
                          + r'[@:][^\s"\',}\]]*'
                      )

                      # Show what we're trying to match
                      matches = re.findall(pattern, content)
                      print(f"  [{short_name}] pattern: {pattern}")
                      print(f"  [{short_name}] matches found: {matches}")

                      new_content, count = re.subn(pattern, image, content)
                      if count > 0:
                          print(f"  [patch] {short_name}: {count} ref(s) -> {image}")
                          content = new_content
                          patched_count += count
                      else:
                          print(f"  [miss]  {short_name}: no matching references in CSV")

                  if patched_count == 0:
                      print("\nWARNING: No image references were patched. "
                            "Check that component names match image paths in the CSV.",
                            file=sys.stderr)
                      # Still continue  the original bundle may work as-is
                  else:
                      print(f"\nPatched {patched_count} total image reference(s).")

                  if content != original_content:
                      with open(csv_path, 'w') as f:
                          f.write(content)
                      print("CSV file updated on disk.")
                  else:
                      print("CSV file unchanged (no patches applied).")
                  PYEOF

                  echo ""
                  echo "--- Patched image references in CSV ---"
                  grep -n 'image:\|RELATED_IMAGE' "${CSV_FILE}" || echo "(none found)"
                  echo "--- End patched image references ---"

                  # ------------------------------------------------------------------
                  # 6. Commit the modified bundle and push
                  # ------------------------------------------------------------------
                  buildah unmount "${container}"

                  PUSH_REPO="quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/gitops-operator-bundle"
                  PUSH_TAG="patched-${PIPELINE_RUN_NAME}"
                  PUSH_TARGET="${PUSH_REPO}:${PUSH_TAG}"

                  echo "=== Committing patched bundle ==="
                  buildah commit "${container}" "${PUSH_TARGET}"

                  echo "=== Pushing to: ${PUSH_TARGET} ==="
                  DIGEST_FILE="/tmp/patched-bundle-digest"
                  buildah push --authfile "${REGISTRY_AUTH_FILE}" \
                    --digestfile "${DIGEST_FILE}" \
                    "${PUSH_TARGET}"

                  DIGEST=$(cat "${DIGEST_FILE}")
                  PATCHED_REF="${PUSH_REPO}@${DIGEST}"

                  echo "============================================"
                  echo "=== PATCHED BUNDLE: ${PATCHED_REF} ==="
                  echo "============================================"
                  printf '%s' "${PATCHED_REF}" > "/tekton/results/patchedBundleImage"
                securityContext:
                  capabilities:
                    add:
                      - SETFCAP
                volumeMounts:
                  - mountPath: /push-credentials
                    name: push-credentials
                    readOnly: true
            volumes:
              - name: push-credentials
                secret:
                  secretName: gitops-operator-bundle-quay-image-repository-image-push
          artifacts: {}
          spanContext:
            traceparent: 00-1070772e949fae646a3da2e60282064b-27a47a3955972686-01
          steps:
            - container: step-patch-and-push-bundle
              imageID: 'registry.access.redhat.com/ubi9/buildah@sha256:49869b7a5957051fa1460bea8b41e071cbb7507a26fabaf5f131d64e05e46d49'
              name: patch-and-push-bundle
              provenance: {}
              terminated:
                containerID: 'cri-o://d8d9e8f34c80fe0e61b0e21706fc269c6b90b5e12d5f1892973ed555a108954c'
                exitCode: 0
                finishedAt: '2026-02-23T12:04:58Z'
                message: '[{"key":"patchedBundleImage","value":"quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/gitops-operator-bundle@sha256:33b16c10b779b02f0a054fa6dcafff72ee5945cb69e7c4b85077c15956c081c2","type":1}]'
                reason: Completed
                startedAt: '2026-02-23T12:04:54Z'
              terminationReason: Completed
          completionTime: '2026-02-23T12:04:59Z'
          startTime: '2026-02-23T12:04:46Z'
          podName: gitops-bundle-e2e-parallel-bx7mh-patch-bundle-images-pod
          results:
            - name: patchedBundleImage
              type: string
              value: 'quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/gitops-operator-bundle@sha256:33b16c10b779b02f0a054fa6dcafff72ee5945cb69e7c4b85077c15956c081c2'
          conditions:
            - lastTransitionTime: '2026-02-23T12:04:59Z'
              message: All Steps have completed executing
              reason: Succeeded
              status: 'True'
              type: Succeeded
          duration: 13s
          reason: Succeeded
      - name: provision-eaas-space
        params:
          - name: ownerName
            value: gitops-bundle-e2e-parallel-bx7mh
          - name: ownerUid
            value: 4dae3aec-64d4-49a8-a450-f01a830ed6a4
        runAfter:
          - parse-metadata
        taskRef:
          params:
            - name: url
              value: 'https://github.com/konflux-ci/build-definitions.git'
            - name: revision
              value: main
            - name: pathInRepo
              value: task/eaas-provision-space/0.1/eaas-provision-space.yaml
          resolver: git
        status:
          taskSpec:
            description: Provisions an ephemeral namespace on an EaaS cluster using a crossplane namespace claim. This namespace can then be used to provision other ephemeral environments for testing.
            params:
              - default: PipelineRun
                description: 'The type of resource that should own the generated namespace claim. Deletion of this resource will trigger deletion of the SpaceRequest. Supported values: `PipelineRun`, `TaskRun`.'
                name: ownerKind
                type: string
              - description: The name of the resource that should own the generated namespace claim. This should either be passed the value of `$(context.pipelineRun.name)` or `$(context.taskRun.name)` depending on the value of `ownerKind`.
                name: ownerName
                type: string
              - description: The uid of the resource that should own the generated namespace claim. This should either be passed the value of `$(context.pipelineRun.uid)` or `$(context.taskRun.uid)` depending on the value of `ownerKind`.
                name: ownerUid
                type: string
            results:
              - description: Name of a Secret containing a kubeconfig used to access the provisioned space.
                name: secretRef
                type: string
            steps:
              - computeResources:
                  limits:
                    cpu: 10m
                    memory: 128Mi
                  requests:
                    cpu: 10m
                    memory: 128Mi
                env:
                  - name: NAMESPACE
                    value: rh-openshift-gitops-tenant
                  - name: OWNER_KIND
                    value: PipelineRun
                  - name: OWNER_NAME
                    value: gitops-bundle-e2e-parallel-bx7mh
                  - name: OWNER_UID
                    value: 4dae3aec-64d4-49a8-a450-f01a830ed6a4
                  - name: CLAIM_NAME
                    value: gitops-bundle-e2e-parallel-bx7mh-provision-eaas-space
                  - name: SECRET
                    value: gitops-bundle-e2e-parallel-bx7mh-provision-eaas-space-secret
                image: 'registry.redhat.io/openshift4/ose-cli:4.13@sha256:73df37794ffff7de1101016c23dc623e4990810390ebdabcbbfa065214352c7c'
                name: request-space
                script: |
                  #!/bin/bash
                  set -eo pipefail

                  case "$OWNER_KIND" in
                    PipelineRun|TaskRun)
                      ;;
                    *)
                      echo "Unsupported value for ownerKind param"
                      exit 1
                      ;;
                  esac

                  cat <<EOF > namespace_claim.yaml
                  apiVersion: eaas.konflux-ci.dev/v1alpha1
                  kind: Namespace
                  metadata:
                    name: $CLAIM_NAME
                    namespace: $NAMESPACE
                    ownerReferences:
                    - apiVersion: tekton.dev/v1
                      kind: $OWNER_KIND
                      name: $OWNER_NAME
                      uid: $OWNER_UID
                  spec:
                    writeConnectionSecretToRef:
                      name: $SECRET
                  EOF

                  NAME=$(oc create -f namespace_claim.yaml -o=jsonpath='{.metadata.name}')

                  if oc wait namespaces.eaas.konflux-ci.dev "$NAME" --for=condition=Ready --timeout=5m; then
                    echo "SecretRef: $SECRET"
                    echo -n "$SECRET" > "/tekton/results/secretRef"
                  else
                    exit 1
                  fi
          artifacts: {}
          spanContext:
            traceparent: 00-1070772e949fae646a3da2e60282064b-0dac4c3fcfe25110-01
          steps:
            - container: step-request-space
              imageID: 'registry.redhat.io/openshift4/ose-cli@sha256:73df37794ffff7de1101016c23dc623e4990810390ebdabcbbfa065214352c7c'
              name: request-space
              provenance: {}
              terminated:
                containerID: 'cri-o://1dc57a09b06ed3d95e1a763bf16c2eaa6177cd79abff9655ae7db3bc3adc420d'
                exitCode: 0
                finishedAt: '2026-02-23T12:06:38Z'
                message: '[{"key":"secretRef","value":"gitops-bundle-e2e-parallel-bx7mh-provision-eaas-space-secret","type":1}]'
                reason: Completed
                startedAt: '2026-02-23T12:04:54Z'
              terminationReason: Completed
          completionTime: '2026-02-23T12:06:39Z'
          startTime: '2026-02-23T12:04:41Z'
          podName: gitops-bundle-e2e-parallel-bx7mh-provision-eaas-space-pod
          results:
            - name: secretRef
              type: string
              value: gitops-bundle-e2e-parallel-bx7mh-provision-eaas-space-secret
          conditions:
            - lastTransitionTime: '2026-02-23T12:06:39Z'
              message: All Steps have completed executing
              reason: Succeeded
              status: 'True'
              type: Succeeded
          duration: 1m 58s
          reason: Succeeded
      - name: provision-cluster
        runAfter:
          - provision-eaas-space
        taskSpec:
          metadata: {}
          results:
            - name: clusterName
              type: string
              value: $(steps.create-cluster.results.clusterName)
          spec: null
          steps:
            - computeResources: {}
              name: get-supported-versions
              params:
                - name: eaasSpaceSecretRef
                  value: $(tasks.provision-eaas-space.results.secretRef)
              ref:
                params:
                  - name: url
                    value: 'https://github.com/konflux-ci/build-definitions.git'
                  - name: revision
                    value: main
                  - name: pathInRepo
                    value: stepactions/eaas-get-supported-ephemeral-cluster-versions/0.1/eaas-get-supported-ephemeral-cluster-versions.yaml
                resolver: git
            - computeResources: {}
              name: create-cluster
              params:
                - name: eaasSpaceSecretRef
                  value: $(tasks.provision-eaas-space.results.secretRef)
                - name: imageContentSources
                  value: |
                    # -------------------------
                    # GitOps Backend
                    # -------------------------
                    - source: registry.redhat.io/openshift-gitops-1/gitops-rhel8
                      mirrors:
                        - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/gitops-rhel8
                        - registry.stage.redhat.io/openshift-gitops-1/gitops-rhel8

                    - source: registry.redhat.io/openshift-gitops-1/gitops-rhel9
                      mirrors:
                        - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/gitops-rhel9
                        - registry.stage.redhat.io/openshift-gitops-1/gitops-rhel9

                    # -------------------------
                    # Console Plugin
                    # -------------------------
                    - source: registry.redhat.io/openshift-gitops-1/console-plugin-rhel8
                      mirrors:
                        - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/console-plugin-rhel8
                        - registry.stage.redhat.io/openshift-gitops-1/console-plugin-rhel8

                    - source: registry.redhat.io/openshift-gitops-1/console-plugin-rhel9
                      mirrors:
                        - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/console-plugin-rhel9
                        - registry.stage.redhat.io/openshift-gitops-1/console-plugin-rhel9

                    # -------------------------
                    # Dex
                    # -------------------------
                    - source: registry.redhat.io/openshift-gitops-1/dex-rhel8
                      mirrors:
                        - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/dex-rhel8
                        - registry.stage.redhat.io/openshift-gitops-1/dex-rhel8

                    - source: registry.redhat.io/openshift-gitops-1/dex-rhel9
                      mirrors:
                        - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/dex-rhel9
                        - registry.stage.redhat.io/openshift-gitops-1/dex-rhel9

                    # -------------------------
                    # Must Gather
                    # -------------------------
                    - source: registry.redhat.io/openshift-gitops-1/must-gather-rhel8
                      mirrors:
                        - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/must-gather-rhel8
                        - registry.stage.redhat.io/openshift-gitops-1/must-gather-rhel8

                    - source: registry.redhat.io/openshift-gitops-1/must-gather-rhel9
                      mirrors:
                        - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/must-gather-rhel9
                        - registry.stage.redhat.io/openshift-gitops-1/must-gather-rhel9

                    # -------------------------
                    # Argo CD
                    # -------------------------
                    - source: registry.redhat.io/openshift-gitops-1/argocd-rhel8
                      mirrors:
                        - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-rhel8
                        - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-rhel8-tmp
                        - registry.stage.redhat.io/openshift-gitops-1/argocd-rhel8

                    - source: registry.redhat.io/openshift-gitops-1/argocd-rhel9
                      mirrors:
                        - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-rhel9
                        - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-rhel9-tmp
                        - registry.stage.redhat.io/openshift-gitops-1/argocd-rhel9

                    # -------------------------
                    # Argo CD Agent
                    # -------------------------
                    - source: registry.redhat.io/openshift-gitops-1/argocd-agent-rhel8
                      mirrors:
                        - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-agent-rhel8
                        - registry.stage.redhat.io/openshift-gitops-1/argocd-agent-rhel8

                    - source: registry.redhat.io/openshift-gitops-1/argocd-agent-rhel9
                      mirrors:
                        - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-agent-rhel9
                        - registry.stage.redhat.io/openshift-gitops-1/argocd-agent-rhel9

                    # -------------------------
                    # Argo Rollouts
                    # -------------------------
                    - source: registry.redhat.io/openshift-gitops-1/argo-rollouts-rhel8
                      mirrors:
                        - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argo-rollouts-rhel8
                        - registry.stage.redhat.io/openshift-gitops-1/argo-rollouts-rhel8

                    - source: registry.redhat.io/openshift-gitops-1/argo-rollouts-rhel9
                      mirrors:
                        - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argo-rollouts-rhel9
                        - registry.stage.redhat.io/openshift-gitops-1/argo-rollouts-rhel9

                    # -------------------------
                    # Operator Bundle
                    # -------------------------
                    - source: registry.redhat.io/openshift-gitops-1/gitops-operator-bundle
                      mirrors:
                        - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/gitops-operator-bundle
                        - registry.stage.redhat.io/openshift-gitops-1/gitops-operator-bundle

                    # -------------------------
                    # GitOps Operator Controller
                    # -------------------------
                    - source: registry.redhat.io/openshift-gitops-1/gitops-rhel8-operator
                      mirrors:
                        - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/gitops-rhel8-operator
                        - registry.stage.redhat.io/openshift-gitops-1/gitops-rhel8-operator

                    - source: registry.redhat.io/openshift-gitops-1/gitops-rhel9-operator
                      mirrors:
                        - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/gitops-rhel9-operator
                        - registry.stage.redhat.io/openshift-gitops-1/gitops-rhel9-operator

                    # -------------------------
                    # Argo CD Extensions
                    # -------------------------
                    - source: registry.redhat.io/openshift-gitops-1/argocd-extensions-rhel8
                      mirrors:
                        - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-extensions-rhel8
                        - registry.stage.redhat.io/openshift-gitops-1/argocd-extensions-rhel8

                    - source: registry.redhat.io/openshift-gitops-1/argocd-extensions-rhel9
                      mirrors:
                        - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-extensions-rhel9
                        - registry.stage.redhat.io/openshift-gitops-1/argocd-extensions-rhel9

                    # -------------------------
                    # Image Updater
                    # -------------------------
                    - source: registry.redhat.io/openshift-gitops-1/argocd-image-updater-rhel8
                      mirrors:
                        - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-image-updater-rhel8
                        - registry.stage.redhat.io/openshift-gitops-1/argocd-image-updater-rhel8

                    - source: registry.redhat.io/openshift-gitops-1/argocd-image-updater-rhel9
                      mirrors:
                        - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-image-updater-rhel9
                        - registry.stage.redhat.io/openshift-gitops-1/argocd-image-updater-rhel9
                - name: timeout
                  value: 60m
                - name: version
                  value: 4.14.57
              ref:
                params:
                  - name: url
                    value: 'https://github.com/konflux-ci/build-definitions.git'
                  - name: revision
                    value: main
                  - name: pathInRepo
                    value: stepactions/eaas-create-ephemeral-cluster-hypershift-aws/0.1/eaas-create-ephemeral-cluster-hypershift-aws.yaml
                resolver: git
          volumes:
            - emptyDir: {}
              name: sources-volume
        status:
          conditions:
            - lastTransitionTime: '2026-02-23T12:06:47Z'
              message: Not all Steps in the Task have finished executing
              reason: Running
              status: Unknown
              type: Succeeded
          podName: gitops-bundle-e2e-parallel-bx7mh-provision-cluster-pod
          spanContext:
            traceparent: 00-1070772e949fae646a3da2e60282064b-9f5bd7edcd86e11f-01
          startTime: '2026-02-23T12:06:39Z'
          steps:
            - container: step-get-supported-versions
              imageID: 'quay.io/konflux-ci/appstudio-utils@sha256:ae8cf015eee19adef1ae5b7a6b346fb1a74acd59bfff55e57744527f283cf1f0'
              name: get-supported-versions
              provenance:
                refSource:
                  digest:
                    sha1: daf4d7360aa1573bbd8fb20ca4297e9c4ba40e7f
                  entryPoint: stepactions/eaas-get-supported-ephemeral-cluster-versions/0.1/eaas-get-supported-ephemeral-cluster-versions.yaml
                  uri: 'git+https://github.com/konflux-ci/build-definitions.git'
              terminated:
                containerID: 'cri-o://c1bb29664ef9a5494ff827f06c0cb781e742113eac355268db3f5cbcd4c4346e'
                exitCode: 0
                finishedAt: '2026-02-23T12:06:48Z'
                message: '[{"key":"versions","value":"[\"4.20\",\"4.19\",\"4.18\",\"4.17\",\"4.16\",\"4.15\",\"4.14\"]","type":4}]'
                reason: Completed
                startedAt: '2026-02-23T12:06:47Z'
              terminationReason: Completed
            - container: step-create-cluster
              imageID: 'quay.io/konflux-ci/appstudio-utils@sha256:ae8cf015eee19adef1ae5b7a6b346fb1a74acd59bfff55e57744527f283cf1f0'
              name: create-cluster
              provenance:
                refSource:
                  digest:
                    sha1: daf4d7360aa1573bbd8fb20ca4297e9c4ba40e7f
                  entryPoint: stepactions/eaas-create-ephemeral-cluster-hypershift-aws/0.1/eaas-create-ephemeral-cluster-hypershift-aws.yaml
                  uri: 'git+https://github.com/konflux-ci/build-definitions.git'
              running:
                startedAt: '2026-02-23T12:06:46Z'
          taskSpec:
            results:
              - name: clusterName
                type: string
                value: $(steps.create-cluster.results.clusterName)
            steps:
              - computeResources: {}
                env:
                  - name: INSECURE_SKIP_TLS_VERIFY
                    value: 'false'
                  - name: KUBECONFIG
                    value: /tmp/kubeconfig
                  - name: KUBECONFIG_VALUE
                    valueFrom:
                      secretKeyRef:
                        key: kubeconfig
                        name: gitops-bundle-e2e-parallel-bx7mh-provision-eaas-space-secret
                image: 'quay.io/konflux-ci/appstudio-utils@sha256:ae8cf015eee19adef1ae5b7a6b346fb1a74acd59bfff55e57744527f283cf1f0'
                name: get-supported-versions
                results:
                  - description: 'List of supported minor versions from newest to oldest. E.g. ["4.15","4.14","4.13"]'
                    name: versions
                    type: array
                script: |
                  #!/bin/bash
                  set -eo pipefail

                  trap 'rm -f "$KUBECONFIG"' EXIT
                  echo "$KUBECONFIG_VALUE" > $KUBECONFIG

                  OC=(oc --insecure-skip-tls-verify="$INSECURE_SKIP_TLS_VERIFY")
                  SV=$("${OC[@]}" get configmap supported-versions -n hypershift -o=jsonpath='{.data.supported-versions}')
                  VERSIONS=$(jq -c '.versions' <<< "$SV")
                  echo "Supported versions: $VERSIONS"
                  echo -n "$VERSIONS" > /tekton/steps/step-get-supported-versions/results/versions
              - computeResources: {}
                env:
                  - name: INSTANCE_TYPE
                    value: m6g.large
                  - name: VERSION
                    value: 4.14.57
                  - name: KUBECONFIG
                    value: /tmp/kubeconfig
                  - name: KUBECONFIG_VALUE
                    valueFrom:
                      secretKeyRef:
                        key: kubeconfig
                        name: gitops-bundle-e2e-parallel-bx7mh-provision-eaas-space-secret
                  - name: INSECURE_SKIP_TLS_VERIFY
                    value: 'false'
                  - name: TIMEOUT
                    value: 60m
                  - name: IMAGE_CONTENT_SOURCES
                    value: |
                      # -------------------------
                      # GitOps Backend
                      # -------------------------
                      - source: registry.redhat.io/openshift-gitops-1/gitops-rhel8
                        mirrors:
                          - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/gitops-rhel8
                          - registry.stage.redhat.io/openshift-gitops-1/gitops-rhel8

                      - source: registry.redhat.io/openshift-gitops-1/gitops-rhel9
                        mirrors:
                          - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/gitops-rhel9
                          - registry.stage.redhat.io/openshift-gitops-1/gitops-rhel9

                      # -------------------------
                      # Console Plugin
                      # -------------------------
                      - source: registry.redhat.io/openshift-gitops-1/console-plugin-rhel8
                        mirrors:
                          - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/console-plugin-rhel8
                          - registry.stage.redhat.io/openshift-gitops-1/console-plugin-rhel8

                      - source: registry.redhat.io/openshift-gitops-1/console-plugin-rhel9
                        mirrors:
                          - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/console-plugin-rhel9
                          - registry.stage.redhat.io/openshift-gitops-1/console-plugin-rhel9

                      # -------------------------
                      # Dex
                      # -------------------------
                      - source: registry.redhat.io/openshift-gitops-1/dex-rhel8
                        mirrors:
                          - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/dex-rhel8
                          - registry.stage.redhat.io/openshift-gitops-1/dex-rhel8

                      - source: registry.redhat.io/openshift-gitops-1/dex-rhel9
                        mirrors:
                          - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/dex-rhel9
                          - registry.stage.redhat.io/openshift-gitops-1/dex-rhel9

                      # -------------------------
                      # Must Gather
                      # -------------------------
                      - source: registry.redhat.io/openshift-gitops-1/must-gather-rhel8
                        mirrors:
                          - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/must-gather-rhel8
                          - registry.stage.redhat.io/openshift-gitops-1/must-gather-rhel8

                      - source: registry.redhat.io/openshift-gitops-1/must-gather-rhel9
                        mirrors:
                          - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/must-gather-rhel9
                          - registry.stage.redhat.io/openshift-gitops-1/must-gather-rhel9

                      # -------------------------
                      # Argo CD
                      # -------------------------
                      - source: registry.redhat.io/openshift-gitops-1/argocd-rhel8
                        mirrors:
                          - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-rhel8
                          - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-rhel8-tmp
                          - registry.stage.redhat.io/openshift-gitops-1/argocd-rhel8

                      - source: registry.redhat.io/openshift-gitops-1/argocd-rhel9
                        mirrors:
                          - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-rhel9
                          - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-rhel9-tmp
                          - registry.stage.redhat.io/openshift-gitops-1/argocd-rhel9

                      # -------------------------
                      # Argo CD Agent
                      # -------------------------
                      - source: registry.redhat.io/openshift-gitops-1/argocd-agent-rhel8
                        mirrors:
                          - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-agent-rhel8
                          - registry.stage.redhat.io/openshift-gitops-1/argocd-agent-rhel8

                      - source: registry.redhat.io/openshift-gitops-1/argocd-agent-rhel9
                        mirrors:
                          - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-agent-rhel9
                          - registry.stage.redhat.io/openshift-gitops-1/argocd-agent-rhel9

                      # -------------------------
                      # Argo Rollouts
                      # -------------------------
                      - source: registry.redhat.io/openshift-gitops-1/argo-rollouts-rhel8
                        mirrors:
                          - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argo-rollouts-rhel8
                          - registry.stage.redhat.io/openshift-gitops-1/argo-rollouts-rhel8

                      - source: registry.redhat.io/openshift-gitops-1/argo-rollouts-rhel9
                        mirrors:
                          - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argo-rollouts-rhel9
                          - registry.stage.redhat.io/openshift-gitops-1/argo-rollouts-rhel9

                      # -------------------------
                      # Operator Bundle
                      # -------------------------
                      - source: registry.redhat.io/openshift-gitops-1/gitops-operator-bundle
                        mirrors:
                          - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/gitops-operator-bundle
                          - registry.stage.redhat.io/openshift-gitops-1/gitops-operator-bundle

                      # -------------------------
                      # GitOps Operator Controller
                      # -------------------------
                      - source: registry.redhat.io/openshift-gitops-1/gitops-rhel8-operator
                        mirrors:
                          - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/gitops-rhel8-operator
                          - registry.stage.redhat.io/openshift-gitops-1/gitops-rhel8-operator

                      - source: registry.redhat.io/openshift-gitops-1/gitops-rhel9-operator
                        mirrors:
                          - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/gitops-rhel9-operator
                          - registry.stage.redhat.io/openshift-gitops-1/gitops-rhel9-operator

                      # -------------------------
                      # Argo CD Extensions
                      # -------------------------
                      - source: registry.redhat.io/openshift-gitops-1/argocd-extensions-rhel8
                        mirrors:
                          - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-extensions-rhel8
                          - registry.stage.redhat.io/openshift-gitops-1/argocd-extensions-rhel8

                      - source: registry.redhat.io/openshift-gitops-1/argocd-extensions-rhel9
                        mirrors:
                          - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-extensions-rhel9
                          - registry.stage.redhat.io/openshift-gitops-1/argocd-extensions-rhel9

                      # -------------------------
                      # Image Updater
                      # -------------------------
                      - source: registry.redhat.io/openshift-gitops-1/argocd-image-updater-rhel8
                        mirrors:
                          - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-image-updater-rhel8
                          - registry.stage.redhat.io/openshift-gitops-1/argocd-image-updater-rhel8

                      - source: registry.redhat.io/openshift-gitops-1/argocd-image-updater-rhel9
                        mirrors:
                          - quay.io/redhat-user-workloads/rh-openshift-gitops-tenant/argocd-image-updater-rhel9
                          - registry.stage.redhat.io/openshift-gitops-1/argocd-image-updater-rhel9
                  - name: IMAGE_CONTENT_SOURCES_FILE
                  - name: TENANT
                    value: rh-openshift-gitops-tenant
                  - name: FIPS
                    value: 'false'
                image: 'quay.io/konflux-ci/appstudio-utils@sha256:ae8cf015eee19adef1ae5b7a6b346fb1a74acd59bfff55e57744527f283cf1f0'
                name: create-cluster
                results:
                  - description: The name of the generated ClusterTemplateInstance resource.
                    name: clusterName
                    type: string
                script: |
                  #!/bin/bash
                  set -eo pipefail

                  # Resolve imageContentSources from file (if provided) or fallback to inline string
                  ICS_VALUE=""
                  if [[ -n "$IMAGE_CONTENT_SOURCES_FILE" ]]; then
                    if [[ -f "$IMAGE_CONTENT_SOURCES_FILE" ]]; then
                      ICS_VALUE="$(cat "$IMAGE_CONTENT_SOURCES_FILE")"
                      echo "Using imageContentSources from file: $IMAGE_CONTENT_SOURCES_FILE"
                    else
                      echo "ERROR: imageContentSourcesFile was provided but file not found: $IMAGE_CONTENT_SOURCES_FILE" >&2
                      exit 1
                    fi
                  elif [[ -n "$IMAGE_CONTENT_SOURCES" ]]; then
                    ICS_VALUE="$IMAGE_CONTENT_SOURCES"
                    echo "Using inline imageContentSources param"
                  fi

                  export ICS_VALUE

                  cat <<EOF > cti.yaml
                  ---
                  apiVersion: clustertemplate.openshift.io/v1alpha1
                  kind: ClusterTemplateInstance
                  metadata:
                    generateName: cluster-
                    labels:
                      eaas.konflux-ci.dev/tenant: $TENANT
                  spec:
                    clusterTemplateRef: hypershift-aws-cluster
                    parameters: []
                  EOF

                  yq -i '.spec.parameters += {"name": "instanceType", "value": strenv(INSTANCE_TYPE)}' cti.yaml
                  yq -i '.spec.parameters += {"name": "version", "value": strenv(VERSION)}' cti.yaml
                  yq -i '.spec.parameters += {"name": "timeout", "value": strenv(TIMEOUT)}' cti.yaml
                  yq -i '.spec.parameters += {"name": "imageContentSources", "value": strenv(ICS_VALUE)}' cti.yaml
                  yq -i '.spec.parameters += {"name": "fips", "value": strenv(FIPS)}' cti.yaml

                  echo "Creating the following resource:"
                  cat cti.yaml

                  trap 'rm -f "$KUBECONFIG"' EXIT
                  echo "$KUBECONFIG_VALUE" > $KUBECONFIG

                  KUBECTL=(kubectl --insecure-skip-tls-verify="$INSECURE_SKIP_TLS_VERIFY")
                  CTI_NAME=$("${KUBECTL[@]}" create -f cti.yaml -o=jsonpath='{.metadata.name}')
                  echo "Created ClusterTemplateInstance $CTI_NAME"
                  echo -n $CTI_NAME > /tekton/steps/step-create-cluster/results/clusterName

                  echo "Waiting for ClusterTemplateInstance to be ready ($TIMEOUT timeout)"
                  if "${KUBECTL[@]}" wait cti "$CTI_NAME" --for=jsonpath='{.status.phase}'=Ready --timeout="$TIMEOUT"; then
                    echo "Successfully provisioned $CTI_NAME"
                    exit 0
                  else
                    "${KUBECTL[@]}" get cti "$CTI_NAME" -o yaml
                    echo "Failed to provision $CTI_NAME"
                    exit 1
                  fi
            volumes:
              - emptyDir: {}
                name: sources-volume
          reason: Running
      - name: install-operator
        params:
          - name: bundleImage
            value: $(tasks.patch-bundle-images.results.patchedBundleImage)
          - name: namespace
            value: openshift-gitops-operator
          - name: installTimeout
            value: 25m
          - name: eaasSpaceSecretRef
            value: $(tasks.provision-eaas-space.results.secretRef)
          - name: clusterName
            value: $(tasks.provision-cluster.results.clusterName)
        runAfter:
          - provision-cluster
          - patch-bundle-images
        taskSpec:
          metadata: {}
          params:
            - name: bundleImage
              type: string
            - name: namespace
              type: string
            - name: installTimeout
              type: string
            - name: eaasSpaceSecretRef
              type: string
            - name: clusterName
              type: string
          spec: null
          steps:
            - computeResources: {}
              name: get-kubeconfig
              params:
                - name: eaasSpaceSecretRef
                  value: $(params.eaasSpaceSecretRef)
                - name: clusterName
                  value: $(params.clusterName)
                - name: credentials
                  value: credentials
              ref:
                params:
                  - name: url
                    value: 'https://github.com/konflux-ci/build-definitions.git'
                  - name: revision
                    value: main
                  - name: pathInRepo
                    value: stepactions/eaas-get-ephemeral-cluster-credentials/0.1/eaas-get-ephemeral-cluster-credentials.yaml
                resolver: git
            - computeResources: {}
              name: install-operator
              params:
                - name: installTimeout
                  value: 25m
                - name: bundleImage
                  value: $(params.bundleImage)
                - name: namespace
                  value: openshift-gitops-operator
                - name: credentials
                  value: credentials
                - name: kubeconfig
                  value: $(steps.get-kubeconfig.results.kubeconfig)
              ref:
                params:
                  - name: url
                    value: 'https://github.com/adamsaleh/release.git'
                  - name: revision
                    value: konflux
                  - name: pathInRepo
                    value: .tekton/steps/install-gitops-operator-bundle.yaml
                resolver: git
          volumes:
            - emptyDir: {}
              name: credentials
        status:
          reason: Pending
      - name: test-operator
        params:
          - name: eaasSpaceSecretRef
            value: $(tasks.provision-eaas-space.results.secretRef)
          - name: clusterName
            value: $(tasks.provision-cluster.results.clusterName)
        runAfter:
          - install-operator
        taskSpec:
          metadata: {}
          params:
            - name: eaasSpaceSecretRef
              type: string
            - name: clusterName
              type: string
          spec: null
          steps:
            - computeResources: {}
              name: get-kubeconfig
              params:
                - name: eaasSpaceSecretRef
                  value: $(params.eaasSpaceSecretRef)
                - name: clusterName
                  value: $(params.clusterName)
                - name: credentials
                  value: credentials
              ref:
                params:
                  - name: url
                    value: 'https://github.com/konflux-ci/build-definitions.git'
                  - name: revision
                    value: main
                  - name: pathInRepo
                    value: stepactions/eaas-get-ephemeral-cluster-credentials/0.1/eaas-get-ephemeral-cluster-credentials.yaml
                resolver: git
            - computeResources: {}
              name: test-operator
              params:
                - name: credentials
                  value: credentials
                - name: kubeconfig
                  value: $(steps.get-kubeconfig.results.kubeconfig)
                - name: branch
                  value: master
                - name: test_dir
                  value: ./test/openshift/e2e/ginkgo/parallel
              ref:
                params:
                  - name: url
                    value: 'https://github.com/adamsaleh/release.git'
                  - name: revision
                    value: konflux
                  - name: pathInRepo
                    value: .tekton/steps/run-gitops-operator-e2e-minimal.yaml
                resolver: git
          volumes:
            - emptyDir: {}
              name: credentials
        status:
          reason: Pending
  spanContext:
    traceparent: 00-1070772e949fae646a3da2e60282064b-b168731ca1c638f2-01
  startTime: '2026-02-23T12:04:28Z'
